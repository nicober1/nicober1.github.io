"use strict";(self.webpackChunkfluentblogs=self.webpackChunkfluentblogs||[]).push([[432],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>y});var r=t(67294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var l=r.createContext({}),c=function(e){var n=r.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=c(e.components);return r.createElement(l.Provider,{value:n},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},g=r.forwardRef((function(e,n){var t=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(t),g=i,y=u["".concat(l,".").concat(g)]||u[g]||d[g]||a;return t?r.createElement(y,o(o({ref:n},p),{},{components:t})):r.createElement(y,o({ref:n},p))}));function y(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var a=t.length,o=new Array(a);o[0]=g;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s[u]="string"==typeof e?e:i,o[1]=s;for(var c=2;c<a;c++)o[c]=t[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}g.displayName="MDXCreateElement"},97593:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>l,default:()=>y,frontMatter:()=>s,metadata:()=>c,toc:()=>u});var r=t(87462),i=t(63366),a=(t(67294),t(3905)),o=["components"],s={keywords:["Notes"]},l=void 0,c={unversionedId:"Developer Random Notes",id:"Developer Random Notes",title:"Developer Random Notes",description:"Sql script to Add Managed Identity of Application to Database",source:"@site/docs/Developer Random Notes.md",sourceDirName:".",slug:"/Developer Random Notes",permalink:"/docs/Developer Random Notes",draft:!1,tags:[],version:"current",frontMatter:{keywords:["Notes"]},sidebar:"myAutogeneratedSidebar",previous:{title:"Azure Powershell",permalink:"/docs/Azure Powershell"},next:{title:"Freelancing",permalink:"/docs/Freelancing"}},p={},u=[],d={toc:u},g="wrapper";function y(e){var n=e.components,t=(0,i.Z)(e,o);return(0,a.kt)(g,(0,r.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Sql script to Add Managed Identity of Application to Database"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"DECLARE @dbName VARCHAR(100) = (SELECT DB_NAME())\nDECLARE @environment CHAR(4) =  CASE\n                                    WHEN (@dbName) LIKE '%dev%' THEN 'dev'\n                                    END;\n\nDECLARE @AppName VARCHAR(100) = 'func-' + @environment + '-latex-01';\nIF EXISTS (SELECT * FROM sys.sysusers WHERE [name] = @AppName)\nBEGIN\n    EXECUTE ('DROP USER ['+ @AppName + ']')\nEND\nEXECUTE ('CREATE USER ['+ @AppName + '] FROM EXTERNAL PROVIDER;')\nEXECUTE ('ALTER ROLE db_datareader ADD MEMBER ['+ @AppName + '];')\nEXECUTE ('ALTER ROLE db_datawriter ADD MEMBER ['+ @AppName + '];')\nEXECUTE ('ALTER ROLE db_owner ADD MEMBER ['+ @AppName + '];')\nGO\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},' public static string GetHtmlTableFromDataTable(DataTable dt)\n        {\n            var sb = new StringBuilder();\n            sb.Append("<div style=\\"overflow-x:auto;\\">");\n            //Table start.\n            sb.Append(@"<table class=\'GeneratedTable\'>");\n            //Adding HeaderRow.\n            sb.Append("<tr>");\n            foreach (DataColumn column in dt.Columns)\n            {\n                sb.Append("<th>" + column.ColumnName + "</th>");\n            }\n            sb.Append("</tr>");\n            //Adding DataRow.\n            foreach (DataRow row in dt.Rows)\n            {\n                sb.Append("<tr>");\n                foreach (DataColumn column in dt.Columns)\n                {\n                    sb.Append("<td>" + row[column.ColumnName] + "</td>");\n                }\n                sb.Append("</tr>");\n            }\n            //Table end.\n            sb.Append("</table>");\n            sb.Append("</div>");\n\n            return sb.ToString();\n        }\n\n        ///////////////////////////////////\n\n        [AttributeUsage(AttributeTargets.All)]\npublic class ScopedRegistrationAttribute : Attribute\n{\n}\n\n[AttributeUsage(AttributeTargets.All)]\npublic class ScopedPriorityRegistrationAttribute : Attribute\n{\n}\n\n[AttributeUsage(AttributeTargets.All)]\npublic class SingletonRegistrationAttribute : Attribute\n{\n}\n\n[AttributeUsage(AttributeTargets.All)]\npublic class TransientRegistrationAttribute : Attribute\n{\n}\n\n[AttributeUsage(AttributeTargets.All)]\npublic class TransientPriorityRegistrationAttribute : Attribute\n{\n}\n\npublic static class RegisterServicesUsingAttributeExtensions\n{\n    public static void RegisterServicesUsingAttribute(this IServiceCollection services)\n    {\n        // Define types that need matching\n        var scopedRegistration = typeof(ScopedRegistrationAttribute);\n        var scopedPriorityRegistration = typeof(ScopedPriorityRegistrationAttribute);\n        var singletonRegistration = typeof(SingletonRegistrationAttribute);\n        var transientRegistration = typeof(TransientRegistrationAttribute);\n        var transientPriorityRegistration = typeof(TransientPriorityRegistrationAttribute);\n        var types = AppDomain.CurrentDomain.GetAssemblies()\n            .SelectMany(s => s.GetTypes())\n            .Where(p => (p.IsDefined(scopedRegistration, true) || p.IsDefined(transientRegistration, true) ||\n                         p.IsDefined(singletonRegistration, true) || p.IsDefined(scopedPriorityRegistration, true) ||\n                         p.IsDefined(transientPriorityRegistration, true)) && !p.IsInterface)\n            .Select(s => new { Service = s.GetInterface($"I{s.Name}"), Implementation = s })\n            .Where(x => x.Service != null);\n        var typesList = types.ToList();\n        var scopedPriorityTypes = typesList\n            .Where(type => type.Implementation.IsDefined(scopedPriorityRegistration, false))\n            .ToList();\n        foreach (var type in scopedPriorityTypes)\n        {\n            services.AddScoped(type.Service ?? throw new InvalidOperationException(), type.Implementation);\n        }\n\n        var transientPriorityTypes = typesList\n            .Where(type => type.Implementation.IsDefined(transientPriorityRegistration, false))\n            .ToList();\n        foreach (var type in transientPriorityTypes)\n        {\n            services.AddTransient(type.Service ?? throw new InvalidOperationException(), type.Implementation);\n        }\n\n        foreach (var type in typesList)\n        {\n            if (type.Implementation.IsDefined(scopedRegistration, false))\n            {\n                services.AddScoped(type.Service ?? throw new InvalidOperationException(), type.Implementation);\n            }\n\n            if (type.Implementation.IsDefined(transientRegistration, false))\n            {\n                services.AddTransient(type.Service ?? throw new InvalidOperationException(), type.Implementation);\n            }\n\n            if (type.Implementation.IsDefined(singletonRegistration, false))\n            {\n                services.AddSingleton(type.Service ?? throw new InvalidOperationException(), type.Implementation);\n            }\n        }\n    }\n}\n\n///////////////\n\npublic class BaseQueryDto\n{\n    public int? PageSize { get; set; }\n    public bool First { get; set; }\n\n    public string? Before { get; set; }\n\n    public string? After { get; set; }\n\n    public bool Last { get; set; }\n    public int? Page { get; set; }\n\n    public string? Search { get; set; }\n}\n\n [HttpGet]\n    [Route("first")]\n    public async Task<ActionResult<KeysetPaginationResult<IdNameDto>>> GetFunds([FromQuery] BaseQueryDto baseQueryDto)\n    {\n        var list = await _cqQueryService.GetFundsAsync(baseQueryDto);\n\n        return Ok(list);\n    }\n\n    public async Task<KeysetPaginationResult<IdNameDto>> GetFundsAsync(BaseQueryDto baseQueryDto)\n    {\n        return await _cqRepositoryManager.cqQuery.GetFundsAsync(baseQueryDto);\n    }\n\n  using LinqKit;\n\n\npublic class cqQueryRepository : RepositoryBase<cqContext, pgp>, IcqQueryRepository\n{\n    private readonly IPaginationService _paginationService;\n    private readonly cqContext _cqContext;\n    private static readonly int CurrentDateAsInt = int.Parse(DateTime.Now.ToString("yyyyMMdd"));\n\n    public cqQueryRepository(cqContext cqContext, IPaginationService paginationService) : base(cqContext)\n    {\n        _cqContext = cqContext;\n        _paginationService = paginationService;\n    }\n\n    public async Task<KeysetPaginationResult<IdNameDto>> GetigosAsync(BaseQueryDto baseQueryDto)\n    {\n        var query = from o in _cqContext.qgos\n                    join oi in _cqContext.qgoidps on o.qgoKey equals oi.qgoKey into g1\n                    from ooi in g1.AsQueryable()\n                        .Where(x => x.qgoidpTypeCode == qgoidpType.idp.ToString()).DefaultIfEmpty()\n                    select new { Id = ooi.qgoidpValue ?? o.qgoId, Name = o.qgoName };\n        if (!string.IsNullOrWhiteSpace(baseQueryDto.Search))\n        {\n            query = query.Where(e => (e.Id + e.Name).Trim().ToLower().Contains(baseQueryDto.Search.Trim().ToLower()));\n        }\n\n        return await _paginationService.KeysetPaginateAsync(query.AsNoTracking(), b => b.Ascending(x => x.Id),\n            async id => await query.AsNoTracking().FirstAsync(x => x.Id == id),\n            q => q.Select(x => new IdNameDto { Id = x.Id, Name = x.Name }));\n    }\n\n    public async Task<KeysetPaginationResult<IdNameDto>> GetFundsAsync(BaseQueryDto baseQueryDto)\n    {\n        var predicate = PredicateBuilder.New<pgpidp>();\n        predicate = predicate.And(p => p.ValidFromDateKey <= CurrentDateAsInt);\n        predicate = predicate.And(p => p.ValidToDateKey >= CurrentDateAsInt);\n        predicate = predicate.And(p => p.pgpidpType == pgpidpTypeEnum.idp_ID.ToString());\n        var query = from p in _cqContext.pgps.AsExpandable()\n                    join pf in _cqContext.pgpFunds.AsExpandable() on p.pgpKey equals pf.pgpKey into g1\n                    from ppf in g1\n                    join pi in _cqContext.pgpidps.AsExpandable() on ppf.pgpKey equals pi.pgpKey into\n                        g2\n                    from ppfpi in g2.AsQueryable().Where(predicate).DefaultIfEmpty()\n                    where p.InceptionDateKey <= CurrentDateAsInt && p.TerminationDateKey >= CurrentDateAsInt &&\n                          p.pgpName != string.Empty\n                    select new { Id = ppfpi.pgpidpValue ?? p.pgpID, Name = p.pgpName };\n        if (!string.IsNullOrWhiteSpace(baseQueryDto.Search))\n        {\n            query = query.Where(e => (e.Id + e.Name).Trim().ToLower().Contains(baseQueryDto.Search.Trim().ToLower()));\n        }\n\n        return await _paginationService.KeysetPaginateAsync(query.AsNoTracking(), b => b.Ascending(x => x.Id),\n            async id => await query.AsNoTracking().FirstAsync(x => x.Id == id),\n            q => q.Select(x => new IdNameDto { Id = x.Id, Name = x.Name }));\n    }\n\n    public async Task<KeysetPaginationResult<IdNameDto>> GetbjpAsync(BaseQueryDto baseQueryDto)\n    {\n        var predicate = PredicateBuilder.New<pgpidp>();\n        predicate = predicate.And(p => p.ValidFromDateKey <= CurrentDateAsInt);\n        predicate = predicate.And(p => p.ValidToDateKey >= CurrentDateAsInt);\n        predicate = predicate.And(p => p.pgpidpType == pgpidpTypeEnum.idp_ID.ToString());\n        var query = from p in _cqContext.pgps\n                    join b in _cqContext.bjp on p.pgpKey equals b.pgpKey into g1\n                    from pb in g1\n                    join pi in _cqContext.pgpidps on pb.pgpKey equals pi.pgpKey into g2\n                    from pbpi in g2.AsQueryable().Where(predicate).DefaultIfEmpty()\n                    where p.InceptionDateKey <= CurrentDateAsInt && p.TerminationDateKey >= CurrentDateAsInt &&\n                          p.pgpName != string.Empty\n                    select new { Id = pbpi.pgpidpValue ?? p.pgpID, Name = p.pgpName };\n        if (!string.IsNullOrWhiteSpace(baseQueryDto.Search))\n        {\n            query = query.Where(e => (e.Id + e.Name).Trim().ToLower().Contains(baseQueryDto.Search.Trim().ToLower()));\n        }\n\n        return await _paginationService.KeysetPaginateAsync(query.AsNoTracking(), b => b.Ascending(x => x.Id),\n            async id => await query.AsNoTracking().FirstAsync(x => x.Id == id),\n            q => q.Select(x => new IdNameDto { Id = x.Id, Name = x.Name }));\n    }\n}\n\n public class HttpLoggingMiddleware : IMiddleware\n    {\n        private readonly IuserService _userService;\n\n        public HttpLoggingMiddleware(IuserService userService)\n        {\n            _userService = userService;\n        }\n\n        public async Task InvokeAsync(HttpContext context, RequestDelegate next)\n        {\n            if (!await ShouldSkipLogging(context))\n            {\n                await _userService.CreateuserEvent(JsonConvert.SerializeObject(new\n                {\n                    user = context.User.Identity?.Name,\n\n                }));\n            }\n\n[]            await next(context);\n\n            if (!await ShouldSkipLogging(context))\n            {\n                await _userService.CreateuserEvent(JsonConvert.SerializeObject(new\n                {\n                    user = context.User.Identity?.Name,\n\n                }));\n            }\n        }\n\n private static Task<bool> ShouldSkipLogging(HttpContext context)\n        {\n            return Task.FromResult(context.GetEndpoint()?.Metadata.GetMetadata<IAllowAnonymous>() != null\n                                   || context.Request.Headers.ContainsKey("X-Bypass-Logging")\n                                   || context.Request.Headers.ContainsKey("x-bypass-logging")\n                                   || context.Request.Query.ContainsKey("skiplogging")\n                                   || context.Request.Query.ContainsKey("SkipLogging")\n                                   || context.Request.Path.StartsWithSegments("/swagger", StringComparison.OrdinalIgnoreCase)\n                                   || context.Request.Path.StartsWithSegments("/log", StringComparison.OrdinalIgnoreCase)\n                                   || context.Request.Path.StartsWithSegments("/signin-oidc", StringComparison.OrdinalIgnoreCase)\n                                   || context.Request.Path.StartsWithSegments("/api/backgroundjobs", StringComparison.OrdinalIgnoreCase)\n                                   || context.Request.Path.StartsWithSegments("/hangfire", StringComparison.OrdinalIgnoreCase)\n            );\n        }\n\n        /////////////////////////\n\n\n\npublic class AzureSqlTokenDbConnectionInterceptor : DbConnectionInterceptor\n{\n    private readonly IAzureSqlTokenProvider _tokenProvider;\n\n    public AzureSqlTokenDbConnectionInterceptor(IAzureSqlTokenProvider tokenProvider)\n    {\n        _tokenProvider = tokenProvider;\n    }\n\n    public override InterceptionResult ConnectionOpening(DbConnection connection, ConnectionEventData eventData,\n        InterceptionResult result)\n    {\n        var sqlConnection = (SqlConnection)connection;\n        if (!ConnectionNeedsAccessToken(sqlConnection)) return base.ConnectionOpening(connection, eventData, result);\n        var (token, _) = _tokenProvider.GetAccessToken();\n        sqlConnection.AccessToken = token;\n        return base.ConnectionOpening(connection, eventData, result);\n    }\n\n    public override async ValueTask<InterceptionResult> ConnectionOpeningAsync(DbConnection connection,\n        ConnectionEventData eventData, InterceptionResult result, CancellationToken cancellationToken = default)\n    {\n        var sqlConnection = (SqlConnection)connection;\n        if (!ConnectionNeedsAccessToken(sqlConnection))\n            return await base.ConnectionOpeningAsync(connection, eventData, result, cancellationToken);\n        var (token, _) = await _tokenProvider.GetAccessTokenAsync(cancellationToken);\n        sqlConnection.AccessToken = token;\n        return await base.ConnectionOpeningAsync(connection, eventData, result, cancellationToken);\n    }\n\n    private static bool ConnectionNeedsAccessToken(IDbConnection connection)\n    {\n        var connectionStringBuilder = new SqlConnectionStringBuilder(connection.ConnectionString);\n        return\n            connectionStringBuilder.DataSource.Contains("database.windows.net", StringComparison.OrdinalIgnoreCase) &&\n            !connectionStringBuilder.DataSource.Contains("SqlExpress", StringComparison.OrdinalIgnoreCase) &&\n            string.IsNullOrEmpty(connectionStringBuilder.UserID);\n    }\n}\n\n// Simple interface that represents a token acquisition abstraction\npublic interface IAzureSqlTokenProvider\n{\n    Task<(string AccessToken, DateTimeOffset ExpiresOn)> GetAccessTokenAsync(\n        CancellationToken cancellationToken = default);\n\n    (string AccessToken, DateTimeOffset ExpiresOn) GetAccessToken();\n}\n\n// Core implementation that performs token acquisition with Azure Identity\npublic class AzureSqlTokenProvider : IAzureSqlTokenProvider\n{\n    private static readonly string[] _azureSqlScopes = new[] { "https://database.windows.net//.default" };\n\n    public async Task<(string AccessToken, DateTimeOffset ExpiresOn)> GetAccessTokenAsync(\n        CancellationToken cancellationToken = default)\n    {\n        var tokenRequestContext = new TokenRequestContext(_azureSqlScopes);\n        var token = await new ChainedTokenCredential(new ManagedIdentityCredential(), new VisualStudioCredential(),\n            new VisualStudioCodeCredential()).GetTokenAsync(tokenRequestContext, cancellationToken);\n        return (token.Token, token.ExpiresOn);\n    }\n\n    public (string AccessToken, DateTimeOffset ExpiresOn) GetAccessToken()\n    {\n        var tokenRequestContext = new TokenRequestContext(_azureSqlScopes);\n        var token = new ChainedTokenCredential(new ManagedIdentityCredential(), new VisualStudioCredential(),\n            new VisualStudioCodeCredential()).GetToken(tokenRequestContext);\n        return (token.Token, token.ExpiresOn);\n    }\n}\n\n// Decorator that caches tokens in the in-memory cache\npublic class CacheAzureSqlTokenProvider : IAzureSqlTokenProvider\n{\n    private const string _cacheKey = nameof(CacheAzureSqlTokenProvider);\n    private readonly IAzureSqlTokenProvider _inner;\n    private readonly IMemoryCache _cache;\n\n    public CacheAzureSqlTokenProvider(IAzureSqlTokenProvider inner, IMemoryCache cache)\n    {\n        _inner = inner;\n        _cache = cache;\n    }\n\n    public async Task<(string AccessToken, DateTimeOffset ExpiresOn)> GetAccessTokenAsync(\n        CancellationToken cancellationToken = default)\n    {\n        return await _cache.GetOrCreateAsync(_cacheKey, async cacheEntry =>\n        {\n            var (token, expiresOn) = await _inner.GetAccessTokenAsync(cancellationToken);\n\n            // AAD access tokens have a default lifetime of 1 hour, so we take a small safety margin\n            cacheEntry.SetAbsoluteExpiration(expiresOn.AddMinutes(-10));\n            return (token, expiresOn);\n        });\n    }\n\n    public (string AccessToken, DateTimeOffset ExpiresOn) GetAccessToken()\n    {\n        return _cache.GetOrCreate(_cacheKey, cacheEntry =>\n        {\n            var (token, expiresOn) = _inner.GetAccessToken();\n\n            // AAD access tokens have a default lifetime of 1 hour, so we take a small safety margin\n            cacheEntry.SetAbsoluteExpiration(expiresOn.AddMinutes(-10));\n            return (token, expiresOn);\n        });\n    }\n\n    ///\n\n\n\n\n\n\npublic class FilterService : IFilterService\n{\n    private readonly HttpClient _client;\n    private readonly IAzureTokenService _azureTokenService;\n    private readonly IHttpContextAccessor _httpContextAccessor;\n    private readonly IConfiguration _configuration;\n    private readonly IContextService _contextService;\n    private readonly ITokenAcquisition _tokenAcquisition;\n\n    public FilterService(HttpClient client, IAzureTokenService azureTokenService, IConfiguration configuration,\n        IHttpContextAccessor httpContextAccessor, IContextService contextService, ITokenAcquisition tokenAcquisition)\n    {\n        _client = client;\n        _azureTokenService = azureTokenService;\n        _configuration = configuration;\n        _httpContextAccessor = httpContextAccessor;\n        _contextService = contextService;\n        _tokenAcquisition = tokenAcquisition;\n    }\n\n    private async Task BuildClient()\n    {\n        _client.BaseAddress = new Uri(_configuration["FilterServiceBaseUri"] ??\n                                      throw new InvalidOperationException(\n                                          "FilterServiceBaseUri not set in configuration"));\n        if (_contextService.IsCientApp() || _contextService.IsQualifiedForAppAuthentication())\n        {\n            var accessToken =\n                await _azureTokenService.GetCachedAccessTokenForAzureResourceDefaultScopeUsingClientSecretCredential(\n                    _configuration["TenantId"], _configuration["ClientId"], _configuration["ISecret"],\n                    _configuration["FilterServiceAppIdUri"]);\n            _client.DefaultRequestHeaders.Add("Authorization", accessToken);\n        }\n        else\n        {\n            var userToken =\n                await _tokenAcquisition.GetAccessTokenForUserAsync(new[]\n                {\n                    $"{_configuration["FilterServiceAppIdUri"]}/.default"\n                });\n            _client.DefaultRequestHeaders.Add("Authorization", $"Bearer {userToken}");\n        }\n    }\n\n    public async Task<string> FetchAllFilterEvents()\n    {\n        if (!_client.DefaultRequestHeaders.Contains("Authorization"))\n            await BuildClient();\n        var response = await _client.GetAsync("/api/v1/event");\n        var responseJson = await response.Content.ReadAsStringAsync();\n        return responseJson;\n    }\n\n    public async Task<string> FetchFilterEvent(string? FilterEvent)\n    {\n        if (!_client.DefaultRequestHeaders.Contains("Authorization"))\n            await BuildClient();\n        var response = await _client.GetAsync($"/api/v1/event?event={FilterEvent}");\n        var responseJson = await response.Content.ReadAsStringAsync();\n        return responseJson;\n    }\n\n    public async Task<string> CreateFilterEvent(string? payload)\n    {\n        if (!_client.DefaultRequestHeaders.Contains("Authorization"))\n            await BuildClient();\n        var httpContent = new StringContent(payload!, Encoding.UTF8, "application/json");\n        var response = await _client.PostAsync("/api/v1/event/create", httpContent);\n        var responseJson = await response.Content.ReadAsStringAsync();\n        return responseJson;\n    }\n\n    public async Task<string> CreateFilterEvent(FilterEventCreationDto payload)\n    {\n        if (!_client.DefaultRequestHeaders.Contains("Authorization"))\n            await BuildClient();\n        var content = JsonConvert.SerializeObject(new\n        {\n            user = payload.User,\n            application = payload.Application,\n            eventName = payload.EventName,\n            description = payload.Description,\n        });\n        var httpContent = new StringContent(content, Encoding.UTF8, "application/json");\n        var response = await _client.PostAsync("/api/v1/event/create", httpContent);\n        var responseJson = await response.Content.ReadAsStringAsync();\n        return responseJson;\n    }\n\n    public async Task<string> CreateFilterEventForEntityUpdate(string appName, ChangeTracker changeTracker)\n    {\n        try\n        {\n            var entitiesToTrack = changeTracker.Entries().Where(e =>\n                e.State != EntityState.Detached && e.State != EntityState.Unchanged && e.State != EntityState.Added);\n            foreach (var entity in entitiesToTrack)\n            {\n                var tableName = entity.Metadata.GetTableName();\n                var userName = _httpContextAccessor?.HttpContext?.User?.Identity?.Name;\n                var endPoint =\n                    $"{_httpContextAccessor?.HttpContext?.Request.Method} {_httpContextAccessor?.HttpContext?.Request.Path.Value}";\n                var keys = entity.State != EntityState.Added\n                    ? entity.Properties.FirstOrDefault(p => p.Metadata.IsPrimaryKey())?.CurrentValue?.ToString()\n                    : null;\n                switch (entity.State)\n                {\n                    case EntityState.Modified:\n                        {\n                            var FilterData = JsonConvert.SerializeObject(new\n                            {\n                                newValue = JsonConvert.SerializeObject(\n                                    entity.Properties.ToDictionary(prop => prop.Metadata.Name,\n                                        prop => prop.CurrentValue)),\n                                oldValue = JsonConvert.SerializeObject(\n                                    entity.Properties.ToDictionary(prop => prop.Metadata.Name,\n                                        prop => prop.OriginalValue))\n                            });\n                            var content = JsonConvert.SerializeObject(new\n                            {\n                                user = userName,\n                                application = appName,\n                                endPoint,\n                                eventName = EventType.DATA_MODIFIED.ToString(),\n                                tableName,\n                                description = FilterData,\n                                keys\n                            });\n                            await CreateFilterEvent(content);\n                            foreach (var prop in entity.Properties)\n                            {\n                                if (prop.OriginalValue?.ToString() == prop.CurrentValue?.ToString()) continue;\n                                if (prop.Metadata.Name.ToLower() == "modifiedat" ||\n                                    prop.Metadata.Name.ToLower() == "modified" ||\n                                    prop.Metadata.Name.ToLower() == "createdat" ||\n                                    prop.Metadata.Name.ToLower() == "created") continue;\n                                var fieldName = prop.Metadata.Name;\n                                FilterData = JsonConvert.SerializeObject(new\n                                {\n                                    fieldName,\n                                    oldValue = prop.OriginalValue,\n                                    newValue = prop.CurrentValue,\n                                });\n                                content = JsonConvert.SerializeObject(new\n                                {\n                                    user = userName,\n                                    application = appName,\n                                    endPoint,\n                                    eventName = EventType.DATA_MODIFIED.ToString(),\n                                    tableName,\n                                    description = FilterData,\n                                    keys\n                                });\n                                await CreateFilterEvent(content);\n                            }\n\n                            break;\n                        }\n                    case EntityState.Deleted:\n                        {\n                            var FilterData = JsonConvert.SerializeObject(new\n                            {\n                                oldValue = JsonConvert.SerializeObject(\n                                    entity.Properties.ToDictionary(prop => prop.Metadata.Name,\n                                        prop => prop.OriginalValue))\n                            });\n                            var content = JsonConvert.SerializeObject(new\n                            {\n                                user = userName,\n                                application = appName,\n                                endPoint,\n                                eventName = EventType.DATA_DELETED.ToString(),\n                                tableName,\n                                description = FilterData,\n                                keys\n                            });\n                            await CreateFilterEvent(content);\n                            break;\n                        }\n                    case EntityState.Added:\n                        {\n                            var FilterData = JsonConvert.SerializeObject(new\n                            {\n                                newValue = JsonConvert.SerializeObject(\n                                    entity.Properties.ToDictionary(prop => prop.Metadata.Name,\n                                        prop => prop.CurrentValue)),\n                            });\n                            var content = JsonConvert.SerializeObject(new\n                            {\n                                user = userName,\n                                application = appName,\n                                endPoint,\n                                eventName = EventType.DATA_ADDED.ToString(),\n                                tableName,\n                                description = FilterData,\n                                keys\n                            });\n                            await CreateFilterEvent(content);\n                            break;\n                        }\n                }\n            }\n\n            return "Filter Data Logged Successfully";\n        }\n        catch (Exception)\n        {\n            return "Filter Data Logging Failed";\n        }\n    }\n\n    public async Task<string> CreateFilterEventForEntityAdded(string appName, IEnumerable<EntityEntry> entities)\n    {\n        try\n        {\n            foreach (var entity in entities.ToList())\n            {\n                var tableName = entity.Metadata.GetTableName();\n                var userName = _httpContextAccessor?.HttpContext?.User?.Identity?.Name;\n                var endPoint =\n                    $"{_httpContextAccessor?.HttpContext?.Request.Method} {_httpContextAccessor?.HttpContext?.Request.Path.Value}";\n                var keys = entity.Properties.FirstOrDefault(p => p.Metadata.IsPrimaryKey())?.CurrentValue?.ToString();\n                var FilterData = JsonConvert.SerializeObject(new\n                {\n                    newValue = JsonConvert.SerializeObject(\n                        entity.Properties.ToDictionary(prop => prop.Metadata.Name, prop => prop.CurrentValue)),\n                });\n                var content = JsonConvert.SerializeObject(new\n                {\n                    user = userName,\n                    application = appName,\n                    endPoint,\n                    eventName = EventType.DATA_ADDED.ToString(),\n                    tableName,\n                    description = FilterData,\n                    keys\n                });\n                await CreateFilterEvent(content);\n            }\n\n            return "Filter Data Logged Successfully";\n        }\n        catch (Exception)\n        {\n            return "Filter Data Logging Failed";\n        }\n    }\n}\n}\n\n\n///\n\n\nusing Azure.Storage.Blobs;\nusing Azure.Storage.Blobs.Models;\nusing Azure.Storage.Sas;\n\n\npublic class AzureStorageService : IAzureStorageService\n{\n    private readonly BlobServiceClient _blobServiceClient;\n\n    public AzureStorageService(BlobServiceClient blobServiceClient)\n    {\n        _blobServiceClient = blobServiceClient;\n    }\n\n    public string GetFileUrl(string filename, string? containerName)\n    {\n        var blobContainerClient = _blobServiceClient.GetBlobContainerClient(containerName);\n        var blob = blobContainerClient.GetBlobClient(filename);\n        return blob.Uri.ToString();\n    }\n\n    public string GetFileUrlWithSasToken(string filename, string containerName, string? storedPolicyName = null)\n    {\n        var container = _blobServiceClient.GetBlobContainerClient(containerName);\n        var blobClient = container.GetBlobClient(filename);\n        var userDelegationKey = _blobServiceClient.GetUserDelegationKey(DateTimeOffset.UtcNow.AddHours(-1),\n            DateTimeOffset.UtcNow.AddDays(7));\n        var sasBuilder = new BlobSasBuilder\n        {\n            BlobContainerName = container.Name,\n            BlobName = filename,\n            Resource = "b",\n        };\n        if (storedPolicyName == null)\n        {\n            sasBuilder.StartsOn = DateTimeOffset.UtcNow.AddHours(-1);\n            sasBuilder.ExpiresOn = DateTimeOffset.UtcNow.AddDays(36500);\n            sasBuilder.SetPermissions(BlobContainerSasPermissions.Read);\n        }\n        else\n        {\n            sasBuilder.Identifier = storedPolicyName;\n        }\n\n        var blobUriBuilder = new BlobUriBuilder(blobClient.Uri)\n        {\n            Sas = sasBuilder.ToSasQueryParameters(userDelegationKey, _blobServiceClient.AccountName)\n        };\n        return blobUriBuilder.ToUri().ToString();\n    }\n\n    public async Task CreateStoredAccessPolicyAsync(string containerName, string? policyName)\n    {\n        var containerClient = _blobServiceClient.GetBlobContainerClient(containerName);\n        var currentAccessPolicy = (await containerClient.GetAccessPolicyAsync()).Value;\n        if (currentAccessPolicy.SignedIdentifiers.Any(x => x.AccessPolicy.Permissions == "r"))\n        {\n            return;\n        }\n\n        var signedIdentifiers = new List<BlobSignedIdentifier>\n        {\n            new()\n            {\n                Id = policyName,\n                AccessPolicy = new BlobAccessPolicy\n                {\n                    StartsOn = DateTimeOffset.UtcNow.AddHours(-1),\n                    ExpiresOn = DateTimeOffset.UtcNow.AddYears(100),\n                    Permissions = "r"\n                }\n            }\n        };\n        await containerClient.SetAccessPolicyAsync(permissions: signedIdentifiers);\n    }\n\n    public async Task<(string blobSasUrl, DateTimeOffset CreatedOn, string ContentType)>\n        SaveFormFileAsBlobWithTagsAsync(IFormFile file,\n            string containerName, Dictionary<string, string?> tagDictionary, string? policy = null)\n    {\n        var uniqueId = tagDictionary["uniqueid"];\n        var fileName = uniqueId + file.FileName.Replace(" ", "_");\n        var contentType = file.ContentType;\n        using var fileStream = new MemoryStream();\n        await file.CopyToAsync(fileStream);\n        fileStream.Seek(0, SeekOrigin.Begin);\n        var container = _blobServiceClient.GetBlobContainerClient(containerName);\n        await container.CreateIfNotExistsAsync();\n        var blob = container.GetBlobClient(fileName);\n        var blobHttpHeader = new BlobHttpHeaders { ContentType = contentType };\n        var options = new BlobUploadOptions { Tags = tagDictionary, Metadata = tagDictionary, HttpHeaders = blobHttpHeader };\n        await blob.UploadAsync(fileStream, options);\n        var properties = await blob.GetPropertiesAsync();\n        //var blobSasUrl = GetFileUrlWithSasToken(fileName, containerName, policy);\n        return (blob.Uri.ToString(), properties.Value.CreatedOn, properties.Value.ContentType);\n    }\n\n    public async Task DeleteFile(string filename, string containerName)\n    {\n        var container = _blobServiceClient.GetBlobContainerClient(containerName);\n        var blob = container.GetBlobClient(filename);\n        await blob.DeleteAsync();\n    }\n\n    public async Task<bool> FileExistsAsync(string filename, string containerName)\n    {\n        var container = _blobServiceClient.GetBlobContainerClient(containerName);\n        var blob = container.GetBlobClient(filename);\n        return await blob.ExistsAsync();\n    }\n\n    public async Task SaveFileAsync(string filename, byte[] file, string? containerName)\n    {\n        var container = _blobServiceClient.GetBlobContainerClient(containerName);\n        await container.CreateIfNotExistsAsync();\n        var blob = container.GetBlobClient(filename);\n        await blob.UploadAsync(new MemoryStream(file), true);\n    }\n\n    public async Task<string> SaveFileAsync(string filename, Stream fileStream, string containerName)\n    {\n        var container = _blobServiceClient.GetBlobContainerClient(containerName);\n        await container.CreateIfNotExistsAsync();\n        var blob = container.GetBlobClient(filename);\n        await blob.UploadAsync(fileStream, true);\n        return blob.Uri.ToString();\n    }\n\n    public async Task<Stream> GetFileAsStreamAsync(string fileName, string containerName)\n    {\n        var container = _blobServiceClient.GetBlobContainerClient(containerName);\n        var blob = container.GetBlobClient(fileName);\n        var ms = new MemoryStream();\n        await blob.DownloadToAsync(ms);\n        return ms;\n    }\n\n    public async Task<Stream> ReadFileAsStream(string fileName, string containerName)\n    {\n        var container = _blobServiceClient.GetBlobContainerClient(containerName);\n        var blob = container.GetBlobClient(fileName);\n        var blobStream = await blob.OpenReadAsync();\n        return blobStream;\n    }\n\n    public async Task<bool> CreateContainerAsync(string containerName)\n    {\n        var container = _blobServiceClient.GetBlobContainerClient(containerName);\n        await container.CreateIfNotExistsAsync();\n        return await container.ExistsAsync();\n    }\n\n    public async Task<List<TaggedBlobItem>> FindBlobsbyTagsAsync(string query)\n    {\n        //Sample Query\n        //var queryString = @"@container = \'animals\' AND ""name"" = \'Rambo\'";\n        // string query = @"""Date"" >= \'2020-04-20\' AND ""Date"" <= \'2020-04-30\'";\n\n        var blobs = new List<TaggedBlobItem>();\n        await foreach (var taggedBlobItem in _blobServiceClient.FindBlobsByTagsAsync(query))\n        {\n            blobs.Add(taggedBlobItem);\n        }\n\n        return blobs;\n    }\n}\n\n//\n\n\npublic class AzureTokenService : IAzureTokenService\n{\n    public IAppCache? _cache;\n\n    public AzureTokenService(IAppCache? cache)\n    {\n        _cache = cache;\n    }\n\n    public async Task<string?> GetAccessTokenForAzureDatabaseDefaultScope()\n    {\n        try\n        {\n            return (await new ChainedTokenCredential(new ManagedIdentityCredential(), new VisualStudioCredential(),\n                new VisualStudioCodeCredential()).GetTokenAsync(\n                new TokenRequestContext(new[] { "https://database.windows.net/.default" }))).Token;\n        }\n        catch (Exception)\n        {\n            return null;\n        }\n    }\n\n    public async Task<string?> GetCachedAccessTokenForAzureDatabaseDefaultScope()\n    {\n        async Task<string?> GetAccessTokenForAzureDatabaseDefaultScopeLocalFunction()\n        {\n            try\n            {\n                return (await new ChainedTokenCredential(new ManagedIdentityCredential(), new VisualStudioCredential(),\n                    new VisualStudioCodeCredential()).GetTokenAsync(\n                    new TokenRequestContext(new[] { "https://database.windows.net/.default" }))).Token;\n            }\n            catch (Exception)\n            {\n                return null;\n            }\n        }\n\n        return await _cache?.GetOrAddAsync("AccessTokenForAzureDatabaseDefaultScope", async entry =>\n            {\n                var record = await GetAccessTokenForAzureDatabaseDefaultScopeLocalFunction();\n                entry.AbsoluteExpiration = record == null ? DateTimeOffset.UtcNow.AddMinutes(-1) : DateTimeOffset.UtcNow.AddMinutes(5);\n                return record;\n            }\n        )!;\n    }\n\n    public async Task<string?> GetAccessTokenForAzureResourceDefaultScopeUsingClientSecretCredential(string tenantId, string clientId, string secret, string resource)\n    {\n        try\n        {\n            var azureCredential =\n                new ClientSecretCredential(tenantId, clientId, secret);\n            var context = new TokenRequestContext(new[]\n                { $"{resource}/.default" });\n            var token = await azureCredential.GetTokenAsync(context, CancellationToken.None);\n            return "Bearer " + token.Token;\n        }\n        catch (Exception)\n        {\n            return null;\n        }\n    }\n\n    public async Task<string?> GetCachedAccessTokenForAzureResourceDefaultScopeUsingClientSecretCredential(string? tenantId, string? clientId, string? secret, string? resource)\n    {\n        async Task<string?> GetTokenLocalFunction()\n        {\n            try\n            {\n                var azureCredential =\n                    new ClientSecretCredential(tenantId, clientId, secret);\n                var context = new TokenRequestContext(new[]\n                    { $"{resource}/.default" });\n                var token = await azureCredential.GetTokenAsync(context, CancellationToken.None);\n                return "Bearer " + token.Token;\n            }\n            catch (Exception)\n            {\n                return null;\n            }\n        }\n\n        return await _cache?.GetOrAddAsync($"AccessToken{resource}", async entry =>\n            {\n                var record = await GetTokenLocalFunction();\n                entry.AbsoluteExpiration = record == null ? DateTimeOffset.UtcNow.AddMinutes(-1) : DateTimeOffset.UtcNow.AddMinutes(5);\n                return record;\n            }\n        )!;\n    }\n}\n\n//\n\n\n[TransientRegistration]\npublic class MemoryCacheService : IMemoryCacheService\n{\n    private readonly IMemoryCache _cache;\n    private static readonly SemaphoreSlim semaphore = new(1, 1);\n\n    public MemoryCacheService(IMemoryCache cache)\n    {\n        _cache = cache;\n    }\n\n    public bool TryToFetchItemFromCache<TItem>(object key, out TItem? value)\n    {\n        if (_cache.TryGetValue(key, out var result))\n        {\n            switch (result)\n            {\n                case null:\n                    value = default;\n                    return true;\n\n                case TItem item:\n                    value = item;\n                    return true;\n            }\n        }\n\n        value = default;\n        return false;\n    }\n\n    public async Task<TItem> SetItemToCache<TItem>(object key, TItem value, MemoryCacheEntryOptions? options = null)\n    {\n        try\n        {\n            await semaphore.WaitAsync();\n            var cacheEntryOptions = new MemoryCacheEntryOptions().SetSlidingExpiration(TimeSpan.FromHours(1))\n                .SetAbsoluteExpiration(TimeSpan.FromHours(2)).SetPriority(CacheItemPriority.Normal).SetSize(1024);\n            using var entry = _cache.CreateEntry(key);\n            entry.SetOptions(options ?? cacheEntryOptions);\n            entry.Value = value;\n            return value;\n        }\n        finally\n        {\n            semaphore.Release();\n        }\n    }\n}\n\n//\n\n\n public static async Task<string> ReadBody(this HttpRequest request)\n    {\n        request.EnableBuffering();\n        var body = new MemoryStream();\n        await request.Body.CopyToAsync(body);\n        request.Body.Seek(0, SeekOrigin.Begin);\n        body.Seek(0, SeekOrigin.Begin);\n        var buffer = new byte[Convert.ToInt32(request.ContentLength)];\n        var unused = await body.ReadAsync(buffer, 0, buffer.Length);\n        var content = Encoding.UTF8.GetString(buffer);\n        return content;\n    }\n\n\n    ///\n\n\n    public static class JsonExtensions\n{\n    public static string BeautifyJson(this string rawJson)\n    {\n        try\n        {\n            var purifiedJson = rawJson.Purify();\n            dynamic parsedJson = JsonConvert.DeserializeObject(purifiedJson)!;\n            var indentedJson = (string)JsonConvert.SerializeObject(parsedJson, Formatting.Indented);\n            var jsonWithoutSlash = indentedJson.Replace(@"\\", "");\n            var editedJson = jsonWithoutSlash.Replace(@"""{", "{");\n            var finalJson = editedJson.Replace(@"}""", "}");\n            return finalJson;\n        }\n        catch (Exception)\n        {\n            return rawJson;\n        }\n    }\n\n    public static string Purify(this string json) =>\n        Regex.Replace(json,\n            "\\\\s+(?=((\\\\\\\\[\\\\\\\\\\"]|[^\\\\\\\\\\"])*\\"(\\\\\\\\[\\\\\\\\\\"]|[^\\\\\\\\\\"])*\\")*(\\\\\\\\[\\\\\\\\\\"]|[^\\\\\\\\\\"])*$)", "");\n}\n\n//\n\n[assembly: WebJobsStartup(typeof(DbMigration), "DbMigration")]\n\n\npublic class DbMigration : IWebJobsStartup\n{\n    public void Configure(IWebJobsBuilder builder)\n    {\n        builder.AddExtension<DbSeedConfigProvider>();\n    }\n\n    internal class DbSeedConfigProvider : IExtensionConfigProvider\n    {\n        private readonly IServiceScopeFactory _scopeFactory;\n\n        public DbSeedConfigProvider(IServiceScopeFactory scopeFactory)\n        {\n            _scopeFactory = scopeFactory;\n        }\n\n        public void Initialize(ExtensionConfigContext context)\n        {\n            using var scope = _scopeFactory.CreateScope();\n            var dbContext = scope.ServiceProvider.GetService<DBDbContext>();\n\n            var migrator = dbContext?.Database.GetService<IMigrator>();\n            migrator?.Migrate();\n        }\n    }\n}\n\n//\n\n\npublic static class ErrorResponseMapper\n{\n    public class ErrorObjectResult : ObjectResult\n    {\n        public ErrorObjectResult(ProblemDetails value) : base(value)\n        {\n            StatusCode = value.Status;\n        }\n    }\n\n    private static ObjectResult CreateResponse(\n        HttpStatusCode statusCode,\n        string type,\n        string title = "",\n        string detail = "",\n        string instance = "")\n    {\n        var problem = new ProblemDetails\n        {\n            Status = (int)statusCode,\n            Type = type,\n            Title = title,\n            Instance = instance,\n            Detail = detail\n        };\n\n        return new ErrorObjectResult(problem);\n    }\n\n    public static ObjectResult BadRequest(\n        string type = "",\n        string title = "",\n        string detail = "",\n        string instance = "") =>\n        CreateResponse(HttpStatusCode.BadRequest, type, title, detail, instance);\n\n    public static ObjectResult InternalServerError(\n        string type = "",\n        string title = "Unexpected Error",\n        string detail = "",\n        string instance = "") =>\n        CreateResponse(HttpStatusCode.InternalServerError, type, title, detail, instance);\n\n    public static ObjectResult NotFound(\n        string type = "",\n        string title = "",\n        string detail = "",\n        string instance = "") =>\n        CreateResponse(HttpStatusCode.NotFound, type, title, detail, instance);\n\n    public static ObjectResult RequestTimeout(string detail = "") => CreateResponse(HttpStatusCode.RequestTimeout, "", "Timeout", detail);\n}\n\n//\n\n\n\npublic class IgnorePropertiesResolver : DefaultContractResolver\n{\n    private readonly HashSet<string?> _propsToIgnore;\n\n    public IgnorePropertiesResolver(IEnumerable<string> propNamesToIgnore)\n    {\n        _propsToIgnore = new HashSet<string?>(propNamesToIgnore);\n    }\n\n    protected override JsonProperty CreateProperty(MemberInfo member, MemberSerialization memberSerialization)\n    {\n        var property = base.CreateProperty(member, memberSerialization);\n\n        if (_propsToIgnore.Contains(property.PropertyName))\n        {\n            property.ShouldSerialize = _ => false;\n        }\n\n        property.PropertyName = property.PropertyName.ToCamelCase();\n\n        return property;\n    }\n}\n\npublic static class StringExtensions\n{\n    public static string? ToCamelCase(this string? input)\n    {\n        if (string.IsNullOrEmpty(input) || !char.IsUpper(input[0]))\n            return input;\n\n        var camelCase = char.ToLower(input[0]) + input[1..];\n        return camelCase;\n    }\n}\n\n\n\npublic class OpenApiConfigurationOptions : DefaultOpenApiConfigurationOptions\n{\n    public override OpenApiVersionType OpenApiVersion { get; set; } = OpenApiVersionType.V3;\n\n    public override OpenApiInfo Info { get; set; } = new()\n    {\n        Version = "1.0.0",\n        Title = "",\n        Description =\n            ""\n    };\n\n    public override List<OpenApiServer> Servers { get; set; } = new();\n}\n\npublic class ImplicitAuthFlow : OpenApiOAuthSecurityFlows\n{\n    private const string AuthorisationUrl = "https://login.microsoftonline.com/{0}/oauth2/v2.0/authorize";\n    private const string RefreshUrl = "https://login.microsoftonline.com/{0}/oauth2/v2.0/token";\n    private const string TokenUrl = "https://login.microsoftonline.com/{0}/oauth2/v2.0/token";\n\n    public ImplicitAuthFlow()\n    {\n        var tenantId =\n            Environment.GetEnvironmentVariable(AZURE_TENANT_ID,\n                EnvironmentVariableTarget.Process);\n        Implicit = new OpenApiOAuthFlow\n        {\n            AuthorizationUrl = new Uri(string.Format(AuthorisationUrl, tenantId)),\n            TokenUrl = new Uri(string.Format(TokenUrl, tenantId)),\n            RefreshUrl = new Uri(string.Format(RefreshUrl, tenantId)),\n            Scopes = { { $"{Environment.GetEnvironmentVariable("AZURE_AUDIENCE")}/.default", " Scope" } }\n        };\n    }\n}\n\npublic class AuthCodeAuthFlow : OpenApiOAuthSecurityFlows\n{\n    private const string AuthorisationUrl = "https://login.microsoftonline.com/{0}/oauth2/v2.0/authorize";\n    private const string TokenUrl = "https://login.microsoftonline.com/{0}/oauth2/v2.0/token";\n    private const string RefreshUrl = "https://login.microsoftonline.com/{0}/oauth2/v2.0/token";\n\n    public AuthCodeAuthFlow()\n    {\n        var tenantId =\n            Environment.GetEnvironmentVariable(AZURE_TENANT_ID,\n                EnvironmentVariableTarget.Process);\n        AuthorizationCode = new OpenApiOAuthFlow\n        {\n            AuthorizationUrl = new Uri(string.Format(AuthorisationUrl, tenantId)),\n            TokenUrl = new Uri(string.Format(TokenUrl, tenantId)),\n            RefreshUrl = new Uri(string.Format(RefreshUrl, tenantId)),\n            Scopes = { { $"{Environment.GetEnvironmentVariable("AZURE_AUDIENCE")}/.default", " Scope" } }\n        };\n    }\n}\n\npublic class ClientCredAuthFlow : OpenApiOAuthSecurityFlows\n{\n    private const string AuthorisationUrl = "https://login.microsoftonline.com/{0}/oauth2/v2.0/authorize";\n    private const string RefreshUrl = "https://login.microsoftonline.com/{0}/oauth2/v2.0/token";\n    private const string TokenUrl = "https://login.microsoftonline.com/{0}/oauth2/v2.0/token";\n    public const string SchemeName = "ClientCredAuthFlow";\n\n    public ClientCredAuthFlow()\n    {\n        var tenantId =\n            Environment.GetEnvironmentVariable(IdentityConfiguration.AZURE_TENANT_ID,\n                EnvironmentVariableTarget.Process);\n        ClientCredentials = new OpenApiOAuthFlow\n        {\n            AuthorizationUrl = new Uri(string.Format(AuthorisationUrl, tenantId)),\n            TokenUrl = new Uri(string.Format(TokenUrl, tenantId)),\n            RefreshUrl = new Uri(string.Format(RefreshUrl, tenantId)),\n            Scopes = { { $"{Environment.GetEnvironmentVariable("AZURE_AUDIENCE")}/.default", " Scope" } }\n        };\n    }\n}\n\n//\n\n\npublic partial class MicrosoftGraphRepository\n{\n    public async Task<List<User>?> GetGraphGroupMembers(string? group)\n    {\n        var graphClient = await MsGraphClient();\n        if (Guid.TryParse(group, out _))\n        {\n            return await GetGraphGroupMembersUsingGroupId(group);\n        }\n\n        var iGraphServiceGroupsCollectionPage = await graphClient?.Groups\n            .Request(new Option[] { new QueryOption("$count", "true") })\n            .Header("ConsistencyLevel", "eventual")\n            .Filter($"displayName eq \'{group}\'")\n            .Select("id,displayName,members")\n            .GetAsync()!;\n\n        return await GetGraphGroupMembersUsingGroupId(iGraphServiceGroupsCollectionPage.FirstOrDefault()?.Id, group);\n    }\n\n    public async Task<List<User>?> GetGraphGroupMembersUsingGroupId(string? groupId, string? groupName = null)\n    {\n        var list = new List<User>();\n\n        if (groupId != null)\n        {\n            var graphClient = await MsGraphClient();\n\n            var members = await graphClient?.Groups[groupId].Members\n                .Request(new Option[] { new QueryOption("$count", "true") })\n                .Header("ConsistencyLevel", "eventual")\n                .GetAsync()!;\n\n            while (members.Count > 0)\n            {\n                list.AddRange(members.Select(x => x as User)!);\n                if (members.NextPageRequest != null)\n                    members = await members.NextPageRequest.GetAsync();\n                else\n                    break;\n            }\n        }\n        else\n        {\n            var members = await _Service.GetMembersForOnPremGroup("gh", groupName);\n            if (!members.Any())\n                return list;\n\n            list.AddRange(members.Select(mail => new User { Mail = mail?.ToLower() }));\n        }\n\n        return list;\n    }\n}\n\n//\n\n\npublic partial class MicrosoftGraphRepository\n{\n    public async Task<GraphServiceClient?> MsGraphClient()\n    {\n        async Task<GraphServiceClient?> GraphClientFunc()\n        {\n            try\n            {\n                Environment.SetEnvironmentVariable(AZURE_CLIENT_SECRET,\n                    _config[CLIENTSECRET_IDENTIFIER]);\n                var credential = new ChainedTokenCredential(new EnvironmentCredential(), new ManagedIdentityCredential());\n                var token = await credential.GetTokenAsync(\n                    requestContext: new TokenRequestContext(new[] { "https://graph.microsoft.com/.default" }));\n\n                var graphServiceClient = new GraphServiceClient(new DelegateAuthenticationProvider(requestMessage =>\n                {\n                    requestMessage.Headers.Authorization = new AuthenticationHeaderValue("Bearer", token.Token);\n\n                    return Task.CompletedTask;\n                }));\n\n                return graphServiceClient;\n            }\n            catch (Exception)\n            {\n                return null;\n            }\n        }\n\n        return await _cache.GetOrAddAsync("GraphClient", entry =>\n        {\n            var record = GraphClientFunc();\n            entry.AbsoluteExpiration = record.Result == null ? DateTimeOffset.UtcNow.AddMinutes(-1) : DateTimeOffset.UtcNow.AddMinutes(5);\n            return record;\n        });\n    }\n}\n\nusing AppRoleAssignment = Microsoft.Graph.AppRoleAssignment;\nusing Group = Microsoft.Graph.Group;\n\n\npublic partial class MicrosoftGraphRepository\n{\n    public async Task<User?> GetGraphUser(string? email)\n    {\n        var graphClient = await MsGraphClient();\n\n        return await graphClient?.Users[email].Request().GetAsync()!;\n    }\n\n    public async Task<(User user, string? profilePictureBase64Encoded)> GetDetailedGraphUser(string? email)\n    {\n        var graphClient = await MsGraphClient();\n\n        var user = await graphClient?.Users[email].Request().GetAsync()!;\n        Stream? photoStream = null;\n        try\n        {\n            photoStream = await graphClient.Users[email].Photo.Content.Request().GetAsync()!;\n        }\n        catch (Exception)\n        {\n            // ignored\n        }\n\n        string? profilePictureBase64Encoded = null;\n        if (photoStream == null) return (user, profilePictureBase64Encoded);\n        using var ms = new MemoryStream();\n        await photoStream.CopyToAsync(ms);\n        profilePictureBase64Encoded = $"data:image/png;base64,{Convert.ToBase64String(ms.ToArray())}";\n\n        return (user, profilePictureBase64Encoded);\n    }\n\n    public async Task<bool> IsGraphUserPresent(string? email)\n    {\n        var graphClient = await MsGraphClient();\n        try\n        {\n            return (await graphClient?.Users[email].Request().GetAsync()!).DisplayName != null;\n        }\n        catch (Exception)\n        {\n            return false;\n        }\n    }\n\n    public async Task<string?> GetGraphUserManager(string? email)\n    {\n        var graphClient = await MsGraphClient();\n        try\n        {\n            var manager = await graphClient?.Users[email].Manager.Request().Select("displayName").GetAsync()! as User;\n            return manager?.DisplayName;\n        }\n        catch (Exception)\n        {\n            return null;\n        }\n    }\n\n    public async Task<Stream?> GetGraphUserProfilePhoto(string? email)\n    {\n        var graphClient = await MsGraphClient();\n        try\n        {\n            return await graphClient?.Users[email].Photo.Content.Request().GetAsync()!;\n        }\n        catch (Exception)\n        {\n            return null;\n        }\n    }\n\n    public async Task<string?> GetGraphUserAppRoleAssignmentsList(string? email)\n    {\n        var graphClient = await MsGraphClient();\n        try\n        {\n            var appRoleAssignmentsCollectionPage = await graphClient?.Users[email].AppRoleAssignments\n                .Request(new Option[] { new QueryOption("$count", "true") })\n                .Header("ConsistencyLevel", "eventual")\n                .Select(x => new { x.PrincipalDisplayName, x.CreatedDateTime, x.PrincipalType, x.ResourceDisplayName })\n                .GetAsync()!;\n            var list = new List<AppRoleAssignment>();\n            while (appRoleAssignmentsCollectionPage.Count > 0)\n            {\n                list.AddRange(appRoleAssignmentsCollectionPage.Select(role => role));\n                if (appRoleAssignmentsCollectionPage.NextPageRequest != null)\n                    appRoleAssignmentsCollectionPage =\n                        await appRoleAssignmentsCollectionPage.NextPageRequest.GetAsync();\n                else\n                    break;\n            }\n\n            return JsonConvert.SerializeObject(list,\n                new JsonSerializerSettings\n                {\n                    NullValueHandling = NullValueHandling.Ignore,\n                    Formatting = Formatting.Indented,\n                    ContractResolver = new IgnorePropertiesResolver(new[] { "ODataType" })\n                });\n        }\n        catch (Exception)\n        {\n            return null;\n        }\n    }\n\n    public async Task<string?> GetGraphUserMemberOfGroupsList(string? email)\n    {\n        var graphClient = await MsGraphClient();\n        try\n        {\n            var memberOfCollectionWithReferencesPage = await graphClient?.Users[email].MemberOf\n                .Request(new Option[] { new QueryOption("$count", "true") })\n                .Header("ConsistencyLevel", "eventual")\n                .Select("id,displayName")\n                .GetAsync()!;\n            var list = new List<Group?>();\n            while (memberOfCollectionWithReferencesPage.Count > 0)\n            {\n                list.AddRange(memberOfCollectionWithReferencesPage.Select(x => x as Group));\n                if (memberOfCollectionWithReferencesPage.NextPageRequest != null)\n                    memberOfCollectionWithReferencesPage =\n                        await memberOfCollectionWithReferencesPage.NextPageRequest.GetAsync();\n                else\n                    break;\n            }\n\n            var groupList = list.Where(g => g != null).SelectMany(g => new[] { g?.DisplayName });\n\n            return JsonConvert.SerializeObject(groupList,\n                new JsonSerializerSettings\n                {\n                    NullValueHandling = NullValueHandling.Ignore,\n                    Formatting = Formatting.Indented,\n                    ContractResolver = new IgnorePropertiesResolver(new[] { "ODataType" })\n                });\n        }\n        catch (Exception)\n        {\n            return null;\n        }\n    }\n\n    public async Task<string?> GetGraphUserTransitiveMemberOfGroupsList(string? email)\n    {\n        var graphClient = await MsGraphClient();\n        try\n        {\n            var memberOfCollectionWithReferencesPage = await graphClient?.Users[email].TransitiveMemberOf\n                .Request(new Option[] { new QueryOption("$count", "true") })\n                .Header("ConsistencyLevel", "eventual")\n                .Select("id,displayName")\n                .GetAsync()!;\n            var list = new List<Group?>();\n            while (memberOfCollectionWithReferencesPage.Count > 0)\n            {\n                list.AddRange(memberOfCollectionWithReferencesPage.Select(x => x as Group));\n                if (memberOfCollectionWithReferencesPage.NextPageRequest != null)\n                    memberOfCollectionWithReferencesPage =\n                        await memberOfCollectionWithReferencesPage.NextPageRequest.GetAsync();\n                else\n                    break;\n            }\n\n            return JsonConvert.SerializeObject(list,\n                new JsonSerializerSettings\n                {\n                    NullValueHandling = NullValueHandling.Ignore,\n                    Formatting = Formatting.Indented,\n                    ContractResolver = new IgnorePropertiesResolver(new[] { "ODataType" })\n                });\n        }\n        catch (Exception)\n        {\n            return null;\n        }\n    }\n}\n\n\npublic class StorageRepository : IStorageRepository\n{\n    private readonly TelemetryClient _telemetryClient;\n    private readonly BlobServiceClient _blobServiceClient;\n    public IConfiguration _config;\n\n    public StorageRepository(TelemetryClient telemetryClient, BlobServiceClient blobServiceClient, IConfiguration config)\n    {\n        _telemetryClient = telemetryClient;\n        _blobServiceClient = blobServiceClient;\n        _config = config;\n    }\n\n    public async Task<Response<BlobContentInfo>> UploadProfilePictureAsBlob(string? blobName, Stream? photoStream)\n    {\n        var blobContainerClient = _blobServiceClient.GetBlobContainerClient(_config[CONTAINER_PROFILE_PICTURE]);\n        var blobClient = blobContainerClient.GetBlobClient(blobName?.ToLower());\n        return await blobClient.UploadAsync(photoStream, true);\n    }\n\n    public async Task<MemoryStream?> GetProfilePictureMemoryStreamFromBlob(string? blobName)\n    {\n        var blobContainerClient = _blobServiceClient.GetBlobContainerClient(_config[CONTAINER_PROFILE_PICTURE]);\n        var blobClient = blobContainerClient.GetBlobClient(blobName?.ToLower());\n        if (!await blobClient.ExistsAsync()) return null;\n        var stream = await blobClient.OpenReadAsync();\n        var memoryStream = new MemoryStream();\n        await stream.CopyToAsync(memoryStream);\n        return memoryStream;\n    }\n\n\n\npublic sealed class ddDbContext : DbContext, IddDbContext\n{\n    public IAppCache? _cache;\n    public IConfiguration? _config;\n\n    public ddDbContext(DbContextOptions<ddDbContext> options, IAppCache? cache, IConfiguration? config) : base(options)\n    {\n        _cache = cache;\n        _config = config;\n        if (!Database.IsRelational()) return;\n        var connection = (SqlConnection)Database.GetDbConnection();\n\n        string? GetAzureDatabaseAccessToken()\n        {\n            try\n            {\n                return new ManagedIdentityCredential().GetToken(\n                    new TokenRequestContext(new[] { "https://database.windows.net/.default" })).Token;\n            }\n            catch (Exception)\n            {\n                return null;\n            }\n        }\n\n        if (_cache != null)\n\n            connection.AccessToken = _cache.GetOrAdd("AzureDatabaseAccessToken", entry =>\n            {\n                var record = GetAzureDatabaseAccessToken();\n                entry.AbsoluteExpiration = record == null ? DateTimeOffset.UtcNow.AddMinutes(-1) : DateTimeOffset.UtcNow.AddMinutes(5);\n                return record;\n            });\n    }\n\n    public DbSet<UserGraph>? UsersGraph { get; set; }\n    public DbSet<UserApp>? UsersApp { get; set; }\n\n    protected override void OnModelCreating(ModelBuilder modelBuilder)\n    {\n        modelBuilder.Entity<UserGraph>().Navigation(g => g.UserApp).AutoInclude();\n        modelBuilder.Entity<UserGraph>().HasAlternateKey(c => c.Mail);\n        modelBuilder.Entity<UserApp>().HasAlternateKey(c => c.Mail);\n        modelBuilder.Entity<UserGraph>()\n            .HasOne(g => g.UserApp).WithOne(u => u.UserGraph).HasForeignKey<UserApp>(u => u.Id);\n    }\n\n    public async Task<int> CustomSaveChangesAsync()\n    {\n        return await SaveChangesAsync(CancellationToken.None);\n    }\n\n    public override async Task<int> SaveChangesAsync(CancellationToken cancellationToken = default)\n    {\n        var entries = ChangeTracker\n            .Entries()\n            .Where(e => e.Entity is BaseEntity && e.State is EntityState.Added or EntityState.Modified);\n\n        foreach (var entityEntry in entries)\n        {\n            ((BaseEntity)entityEntry.Entity).Updated = DateTime.Now;\n\n            if (entityEntry.State == EntityState.Added)\n            {\n                ((BaseEntity)entityEntry.Entity).Created = DateTime.Now;\n            }\n        }\n\n        return await base.SaveChangesAsync(cancellationToken);\n    }\n}\n}\n\n\npublic class DbContextDesignHelper\n{\n    private class ddDbContextFactory : IDesignTimeDbContextFactory<ddDbContext>\n    {\n        public ddDbContext CreateDbContext(string[] args)\n        {\n            var optionsBuilder = new DbContextOptionsBuilder<ddDbContext>();\n            optionsBuilder.UseSqlServer(GetDBConnection());\n            return new ddDbContext(optionsBuilder.Options, null, null!);\n        }\n    }\n\n    private static SqlConnection GetDBConnection()\n    {\n        IConfiguration config = new ConfigurationBuilder().SetBasePath(Path.Combine(Directory.GetCurrentDirectory()))\n            .AddJsonFile("local.settings.json").Build();\n        var token = new ManagedIdentityCredential().GetToken(\n            new TokenRequestContext(new[] { "https://database.windows.net/.default" }));\n        var conn = new SqlConnection\n        {\n            ConnectionString = config.GetSection("Values").GetValue<string>("conn"),\n            AccessToken = token.Token\n        };\n        return conn;\n    }\n}\n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM sys.database_principals\n")))}y.isMDXComponent=!0}}]);