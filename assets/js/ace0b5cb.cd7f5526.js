"use strict";(self.webpackChunkfluentblogs=self.webpackChunkfluentblogs||[]).push([[4315],{3905:(e,n,t)=>{t.d(n,{Zo:()=>l,kt:()=>m});var r=t(67294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var c=r.createContext({}),p=function(e){var n=r.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},l=function(e){var n=p(e.components);return r.createElement(c.Provider,{value:n},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},A=r.forwardRef((function(e,n){var t=e.components,i=e.mdxType,o=e.originalType,c=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),d=p(t),A=i,m=d["".concat(c,".").concat(A)]||d[A]||u[A]||o;return t?r.createElement(m,a(a({ref:n},l),{},{components:t})):r.createElement(m,a({ref:n},l))}));function m(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var o=t.length,a=new Array(o);a[0]=A;var s={};for(var c in n)hasOwnProperty.call(n,c)&&(s[c]=n[c]);s.originalType=e,s[d]="string"==typeof e?e:i,a[1]=s;for(var p=2;p<o;p++)a[p]=t[p];return r.createElement.apply(null,a)}return r.createElement.apply(null,t)}A.displayName="MDXCreateElement"},47597:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>m,frontMatter:()=>s,metadata:()=>p,toc:()=>d});var r=t(87462),i=t(63366),o=(t(67294),t(3905)),a=["components"],s={keywords:["ASP.NET.Core.Web.API.Startup"]},c=void 0,p={unversionedId:"ASP.NET Core Web API Program",id:"ASP.NET Core Web API Program",title:"ASP.NET Core Web API Program",description:"",source:"@site/docs/ASP.NET Core Web API Program.md",sourceDirName:".",slug:"/ASP.NET Core Web API Program",permalink:"/docs/ASP.NET Core Web API Program",draft:!1,tags:[],version:"current",frontMatter:{keywords:["ASP.NET.Core.Web.API.Startup"]},sidebar:"myAutogeneratedSidebar",previous:{title:"ASP.NET Core Web API Notes",permalink:"/docs/ASP.NET Core Web API Notes"},next:{title:"ASP.NET Core Web API RepositoryPattern",permalink:"/docs/ASP.NET Core Web API RepositoryPattern"}},l={},d=[],u={toc:d},A="wrapper";function m(e){var n=e.components,t=(0,i.Z)(e,a);return(0,o.kt)(A,(0,r.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-csharp"},'\nvar builder = WebApplication.CreateBuilder(args);\nvar config = builder.Configuration;\n\nconfig.AddAzureKeyVault(new SecretClient(new Uri(config["KeyVaultUri"]), new ManagedIdentityCredential()),\n    new AzureKeyVaultConfigurationOptions { ReloadInterval = TimeSpan.FromSeconds(600) });\n\nvar startup = new Startup(config);\n\nstartup.ConfigureServices(builder.Services);\nvar app = builder.Build();\nvar logger = new LoggerFactory().CreateLogger<Startup>();\n\nstartup.Configure(app, app.Environment, logger);\n\napp.MigrateDatabase<DatabaseDbContext>().Run();\n\n\nbuilder.Services.Configure<MailSettings>(Configuration.GetSection("MailSettings"));\nbuilder.Services.AddAzureClients(client =>\n        {\n            client.AddBlobServiceClient(new Uri(Configuration["StorageAccountUri"]));\n            client.AddTableServiceClient(new Uri(configuration["StorageTableAccountUri"]));\n            client.UseCredential(new ManagedIdentityCredential());\n        });\nbuilder.Services.AddControllers();\nbuilder.Services.AddTransient<ProblemDetailsFactory, SampleProblemDetailsFactory>();\nbuilder.Services.Configure<ApiBehaviorOptions>(options =>\n{\n    options.SuppressModelStateInvalidFilter = true;\n        options.SuppressMapClientErrors = true;\n         options.ClientErrorMapping[StatusCodes.Status404NotFound].Link =\n            "https://httpstatuses.com/404";\n\n});\n\nbuilder.Services.AddProblemDetails(options =>\n        options.CustomizeProblemDetails = (context) =>\n        {\n\n            var mathErrorFeature = context.HttpContext.Features\n                                                       .Get<MathErrorFeature>();\n            if (mathErrorFeature is not null)\n            {\n                (string Detail, string Type) details = mathErrorFeature.MathError switch\n                {\n                    MathErrorType.DivisionByZeroError =>\n                    ("Divison by zero is not defined.",\n                                          "https://wikipedia.org/wiki/Division_by_zero"),\n                    _ => ("Negative or complex numbers are not valid input.",\n                                          "https://wikipedia.org/wiki/Square_root")\n                };\n\n                context.ProblemDetails.Type = details.Type;\n                context.ProblemDetails.Title = "Bad Input";\n                context.ProblemDetails.Detail = details.Detail;\n            }\n        }\n    );\nbuilder.Services.AddHttpClient();\nbuilder.Services.AddEndpointsApiExplorer();\n\nbuilder.Services.Configure<RouteOptions>(options =>\n{ options.LowercaseUrls = true; options.LowercaseQueryStrings = true; });\n\nservices.AddMemoryCache();\n\n services.AddHangfire(c =>\n            {\n                c.SetDataCompatibilityLevel(CompatibilityLevel.Version_180);\n                c.UseSimpleAssemblyNameTypeSerializer();\n                c.UseRecommendedSerializerSettings();\n                c.UseColouredConsoleLogProvider();\n                c.UseMemoryStorage();\n            }\n        );\n        JobStorage.Current = new MemoryStorage();\n        services.AddSingleton<IBackgroundJobClient>(x => new BackgroundJobClient());\n        services.AddHangfireServer();\n        services.AddSingleton<IAzureSqlTokenProvider, AzureSqlTokenProvider>();\n\n        services.Decorate<IAzureSqlTokenProvider, CacheAzureSqlTokenProvider>();\n\n        services.AddSingleton<AzureSqlTokenDbConnectionInterceptor>();\n\n        services.AddDbContext<DatabaseDbContext>((provider, options) =>\n        {\n            options.UseSqlServer(Configuration.GetConnectionString("ConnectionStringDatabase"),\n                sqlServerOptions =>\n                {\n                    sqlServerOptions.MigrationsAssembly("Repository.Project");\n                    sqlServerOptions.UseQuerySplittingBehavior(QuerySplittingBehavior.SplitQuery);\n                });\n            options.AddInterceptors(provider.GetRequiredService<AzureSqlTokenDbConnectionInterceptor>());\n        });\n\nservices.AddApplicationInsightsTelemetry();\nservices.AddHttpContextAccessor();\n        services.AddLazyCache();\n\n                services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)\n            .AddMicrosoftIdentityWebApi(Configuration.GetSection("AzureAd"))\n            .EnableTokenAcquisitionToCallDownstreamApi()\n            .AddInMemoryTokenCaches();\n\n        services.AddAuthentication(OpenIdConnectDefaults.AuthenticationScheme)\n            .AddMicrosoftIdentityWebApp(Configuration.GetSection("AzureAd"))\n            .EnableTokenAcquisitionToCallDownstreamApi()\n            .AddInMemoryTokenCaches();\n\n        services.Configure<MicrosoftIdentityOptions>(options =>\n        {\n            options.ClientSecret = Configuration["Secret"];\n        });\n\nservices.Configure<ConfidentialClientApplicationOptions>(OpenIdConnectDefault.AuthenticationScheme, options =>\n{\n options.ClientSecret = Configuration["Secret"];\n});\n\n services.Configure<ConfidentialClientApplicationOptions>(JwtBearerDefaults.AuthenticationScheme, options =>\n{\n options.ClientSecret = Configuration["Secret"];\n});\n\n\n services.AddAuthentication(OpenIdConnectDefaults.AuthenticationScheme)\n    .AddMicrosoftIdentityWebApp(microsoftIdentityOptions=>\n    {\n      Configuration.Bind("AzureAd", microsoftIdentityOptions);\n      microsoftIdentityOptions.ClientCredentials = new CredentialDescription[] {\n        CertificateDescription.FromKeyVault("https://msidentitywebsamples.vault.azure.net",\n                                            "MicrosoftIdentitySamplesCert")};\n    })\n  .EnableTokenAcquisitionToCallDownstreamApi(confidentialClientApplicationOptions=>\n    {\n    Configuration.Bind("AzureAd", confidentialClientApplicationOptions); \n    })\n  .AddInMemoryTokenCaches();\n \n\n  services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)\n   .AddMicrosoftIdentityWebApi(\n     configureJwtBearerOptions =>\n     {\n      Configuration.Bind("AzureAd", configureJwtBearerOptions);\n     }, microsoftIdentityOptions=>\n     {\n      Configuration.Bind("AzureAd", microsoftIdentityOptions);\n      microsoftIdentityOptions.TokenDecryptionCertificates = new CertificateDescription[] {\n         CertificateDescription.FromKeyVault("https://msidentitywebsamples.vault.azure.net",\n                                             "MicrosoftIdentitySamplesDecryptCert")};\n     })\n   .EnableTokenAcquisitionToCallDownstreamApi(\n     confidentialClientApplicationOptions=>\n     {\n      Configuration.Bind("AzureAd", confidentialClientApplicationOptions); \n     })\n   .AddInMemoryTokenCaches();\n\n   \n\n        services.AddAuthorization(options =>\n            options.AddPolicy("Admin",\n                policy => policy.RequireRole("admin-role"))\n        );\n\n\n\n        services.AddAuthorization(options =>\n        {\n            options.AddPolicy("AzureAdPolicy", policy =>\n            {\n                policy.AddAuthenticationSchemes(OpenIdConnectDefaults.AuthenticationScheme)\n                    .RequireAuthenticatedUser();\n            });\n        });\n\n        services.AddControllers().AddNewtonsoftJson((options) =>\n        {\n            options.SerializerSettings.ReferenceLoopHandling = Newtonsoft.Json.ReferenceLoopHandling.Ignore;\n        });\n\n        services.AddCors(options =>\n        {\n            options.AddDefaultPolicy(\n                policy =>\n                {\n                    policy.WithOrigins(Configuration["AllowedOrigins"].Split(","))\n                        .SetIsOriginAllowedToAllowWildcardSubdomains().AllowAnyHeader()\n                        .AllowAnyMethod().AllowCredentials().SetPreflightMaxAge(TimeSpan.FromSeconds(90)).Build();\n                });\n        });\n services.AddPagination(o =>\n        {\n            o.CanChangeSizeFromQuery = true;\n            o.DefaultSize = 100;\n            o.MaxSize = 1000;\n            o.AfterQueryParameterName = "after";\n            o.BeforeQueryParameterName = "before";\n            o.FirstQueryParameterName = "first";\n            o.LastQueryParameterName = "last";\n            o.PageSizeQueryParameterName = "pagesize";\n            o.PageQueryParameterName = "page";\n        });\n           services.AddAutoMapper(typeof(AutoMapperProfile));\n\n        services.AddSwaggerGenNewtonsoftSupport();\n\nbuilder.Services.AddSwaggerGen(c =>\n{\n    c.SwaggerDoc("v1", new OpenApiInfo { Title = "WebAPI", Version = "v1" });\n    c.SwaggerDoc("v2", new OpenApiInfo { Title = "My API", Version = "v2" });\n    c.EnableTryItOutByDefault();\n    c.EnableAutoGeneratedEnumDescriptions();\n    c.IgnoreObsoleteActions();\n    c.IgnoreObsoleteProperties();\n    c.IgnoreNonPublicMethods();\n    c.IgnoreNonPublicProperties();\n    c.IgnoreMapAttributeProperties();\n     c.EnableAnnotations();\n    var xmlFilename = $"{Assembly.GetExecutingAssembly().GetName().Name}.xml";\n    c.IncludeXmlComments(Path.Combine(AppContext.BaseDirectory, xmlFilename));\n     c.AddSecurityDefinition("oauth2", new OpenApiSecurityScheme\n            {\n                Type = SecuritySchemeType.OAuth2,\n                Flows = new OpenApiOAuthFlows\n                {\n                    Implicit = new OpenApiOAuthFlow\n                    {\n                        AuthorizationUrl = new Uri($"{Configuration["AzureAd:Instance"]}/{Configuration["AzureAd:TenantId"]}/oauth2/v2.0/authorize"),\n                        TokenUrl = new Uri($"{Configuration["AzureAd:Instance"]}/{Configuration["AzureAd:TenantId"]}/oauth2/v2.0/token"),\n                        Scopes = { { $"api://{Configuration["AzureAd:ClientId"]}/.deafult", "API Access" } }\n                    }\n                }\n            });\n\n            c.AddSecurityRequirement(new OpenApiSecurityRequirement\n            {\n                {\n                    new OpenApiSecurityScheme\n                    {\n                        Reference = new OpenApiReference\n                        {\n                            Type = ReferenceType.SecurityScheme,\n                            Id = "oauth2"\n                        },\n                        Scheme ="oauth2",\n                        Name ="oauth2",\n                        In = ParameterLocation.Header\n                    }, new List<string>()\n                }\n            });\n            c.AddSecurityDefinition(name: "Bearer",\n                securityScheme: new OpenApiSecurityScheme\n                {\n                    Name = "Authorization",\n                    Description =\n                        "Enter the Bearer Authorization string as following: `Bearer Generated-JWT-Token`",\n                    In = ParameterLocation.Header,\n                    Type = SecuritySchemeType.ApiKey,\n                    Scheme = "Bearer"\n                });\n            c.AddSecurityRequirement(new OpenApiSecurityRequirement\n            {\n                {\n                    new OpenApiSecurityScheme\n                    {\n                        Name = "Bearer",\n                        In = ParameterLocation.Header,\n                        Reference = new OpenApiReference { Id = "Bearer", Type = ReferenceType.SecurityScheme }\n                    },\n                    new List<string>()\n                }\n            });\n\n            c.SchemaFilter<EnumSchemaFilter>();\n    c.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme\n    {\n        Description = "JWT Authorization header using the Bearer scheme",\n        Type = SecuritySchemeType.Http,\n        Scheme = "bearer",\n        BearerFormat = "JWT"\n    });\n    c.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme\n    {\n        Type = SecuritySchemeType.Http,\n        Scheme = "bearer",\n        BearerFormat = "JWT",\n        In = ParameterLocation.Header,\n        Description = "JWT Authorization header using the Bearer scheme."\n    });\n\n    c.AddSecurityRequirement(new OpenApiSecurityRequirement\n    {\n        {\n            new OpenApiSecurityScheme\n            {\n                Reference = new OpenApiReference\n                {\n                    Type = ReferenceType.SecurityScheme,\n                    Id = "Bearer"\n                }\n            },\n            new string[] {}\n        }\n    });\n});\n\n builder.Services.Configure<ForwardedHeadersOptions>(options =>\n            {\n                options.ForwardedHeaders =\n                    ForwardedHeaders.XForwardedFor | ForwardedHeaders.XForwardedProto;\n                options.KnownNetworks.Clear();\n                options.KnownProxies.Clear();\n            });\n\n            var app = builder.Build();\n\n            app.UseForwardedHeaders();\n\n            // Configure the HTTP request pipeline.\n            if (!app.Environment.IsDevelopment())\n            {\n                app.UseExceptionHandler("/Error");\n                app.UseHsts();\n            }\n\nvar app = builder.Build();\n\napp.UseSwagger();\napp.UseSwaggerUI(c =>\n{\n    c.SwaggerEndpoint("/swagger/v1/swagger.json", "WebAPI v1");\n    c.DocumentTitle = "My API Documentation";\n    c.RoutePrefix = string.Empty;\n    //relative path in wwwroot\n    c.InjectStylesheet("/swagger-ui/custom.css");\n     c.InjectStylesheet("/swagger-ui/SwaggerDark.css");\n    c.EnablePersistAuthorization();\n    c.EnableTryItOutByDefault();\n     c.DocExpansion(Swashbuckle.AspNetCore.SwaggerUI.DocExpansion.None);\n     c.OAuthUseBasicAuthenticationWithAccessCodeGrant();\n            c.DocExpansion(DocExpansion.List);\n            c.EnableTryItOutByDefault();\n            c.EnablePersistAuthorization();\n});\napp.UseDeveloperExceptionPage();\napp.UseHttpsRedirection();\napp.UseStaticFiles();\napp.MapControllers();\n\napp.UseExceptionHandler();\napp.UseStatusCodePages();\napp.UseRouting();\n\n        app.UseCors();\n\nif (app.Environment.IsDevelopment())\n{\n    app.UseDeveloperExceptionPage();\n}\napp.UseAuthorization();\napp.UseAuthorization();\n        app.UseMiddleware<LoggingMiddleware>();\n        app.UseAuthentication();\napp.AddAuthentication();\n\napp.MapControllers();\n\napp.UseForwardedHeaders(new ForwardedHeadersOptions\n{\n    ForwardedHeaders = ForwardedHeaders.All\n});\n\napp.UseEndpoints(endpoints =>\n        {\n            endpoints.MapControllers();\n            endpoints.MapHangfireDashboard("/hangfire", new DashboardOptions\n            {\n                Authorization = new List<IDashboardAuthorizationFilter>(),\n                AppPath = "/hangfire",\n                DashboardTitle = "Hangfire Dashboard",\n            }).RequireAuthorization("AzureAdPolicy");\n        });\n var config = app.ApplicationServices.GetService(typeof(IConfiguration)) as IConfiguration;\n        var enableSwagger = bool.Parse(config.GetValue<string>("EnableSwagger") ?? "false");\napp.Run();\n')))}m.isMDXComponent=!0}}]);