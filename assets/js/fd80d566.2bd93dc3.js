"use strict";(self.webpackChunkfluentblogs=self.webpackChunkfluentblogs||[]).push([[432],{3905:(e,n,t)=>{t.d(n,{Zo:()=>l,kt:()=>g});var r=t(67294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,i=function(e,n){if(null==e)return{};var t,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var c=r.createContext({}),p=function(e){var n=r.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},l=function(e){var n=p(e.components);return r.createElement(c.Provider,{value:n},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},y=r.forwardRef((function(e,n){var t=e.components,i=e.mdxType,a=e.originalType,c=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),u=p(t),y=i,g=u["".concat(c,".").concat(y)]||u[y]||d[y]||a;return t?r.createElement(g,o(o({ref:n},l),{},{components:t})):r.createElement(g,o({ref:n},l))}));function g(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var a=t.length,o=new Array(a);o[0]=y;var s={};for(var c in n)hasOwnProperty.call(n,c)&&(s[c]=n[c]);s.originalType=e,s[u]="string"==typeof e?e:i,o[1]=s;for(var p=2;p<a;p++)o[p]=t[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}y.displayName="MDXCreateElement"},97593:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>g,frontMatter:()=>s,metadata:()=>p,toc:()=>u});var r=t(87462),i=t(63366),a=(t(67294),t(3905)),o=["components"],s={keywords:["Notes"]},c=void 0,p={unversionedId:"Developer Random Notes",id:"Developer Random Notes",title:"Developer Random Notes",description:"Sql script to Add Managed Identity of Application to Database",source:"@site/docs/Developer Random Notes.md",sourceDirName:".",slug:"/Developer Random Notes",permalink:"/docs/Developer Random Notes",draft:!1,tags:[],version:"current",frontMatter:{keywords:["Notes"]},sidebar:"myAutogeneratedSidebar",previous:{title:"Azure Powershell",permalink:"/docs/Azure Powershell"},next:{title:"Freelancing",permalink:"/docs/Freelancing"}},l={},u=[],d={toc:u},y="wrapper";function g(e){var n=e.components,t=(0,i.Z)(e,o);return(0,a.kt)(y,(0,r.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Sql script to Add Managed Identity of Application to Database"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"DECLARE @dbName VARCHAR(100) = (SELECT DB_NAME())\nDECLARE @environment CHAR(4) =  CASE\n                                    WHEN (@dbName) LIKE '%dev%' THEN 'dev'\n                                    END;\n\nDECLARE @AppName VARCHAR(100) = 'func-' + @environment + '-latex-01';\nIF EXISTS (SELECT * FROM sys.sysusers WHERE [name] = @AppName)\nBEGIN\n    EXECUTE ('DROP USER ['+ @AppName + ']')\nEND\nEXECUTE ('CREATE USER ['+ @AppName + '] FROM EXTERNAL PROVIDER;')\nEXECUTE ('ALTER ROLE db_datareader ADD MEMBER ['+ @AppName + '];')\nEXECUTE ('ALTER ROLE db_datawriter ADD MEMBER ['+ @AppName + '];')\nEXECUTE ('ALTER ROLE db_owner ADD MEMBER ['+ @AppName + '];')\nGO\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-csharp"},' public static string GetHtmlTableFromDataTable(DataTable dt)\n        {\n            var sb = new StringBuilder();\n            sb.Append("<div style=\\"overflow-x:auto;\\">");\n            //Table start.\n            sb.Append(@"<table class=\'GeneratedTable\'>");\n            //Adding HeaderRow.\n            sb.Append("<tr>");\n            foreach (DataColumn column in dt.Columns)\n            {\n                sb.Append("<th>" + column.ColumnName + "</th>");\n            }\n            sb.Append("</tr>");\n            //Adding DataRow.\n            foreach (DataRow row in dt.Rows)\n            {\n                sb.Append("<tr>");\n                foreach (DataColumn column in dt.Columns)\n                {\n                    sb.Append("<td>" + row[column.ColumnName] + "</td>");\n                }\n                sb.Append("</tr>");\n            }\n            //Table end.\n            sb.Append("</table>");\n            sb.Append("</div>");\n\n            return sb.ToString();\n        }\n\n        ///////////////////////////////////\n\n        [AttributeUsage(AttributeTargets.All)]\npublic class ScopedRegistrationAttribute : Attribute\n{\n}\n\n[AttributeUsage(AttributeTargets.All)]\npublic class ScopedPriorityRegistrationAttribute : Attribute\n{\n}\n\n[AttributeUsage(AttributeTargets.All)]\npublic class SingletonRegistrationAttribute : Attribute\n{\n}\n\n[AttributeUsage(AttributeTargets.All)]\npublic class TransientRegistrationAttribute : Attribute\n{\n}\n\n[AttributeUsage(AttributeTargets.All)]\npublic class TransientPriorityRegistrationAttribute : Attribute\n{\n}\n\npublic static class RegisterServicesUsingAttributeExtensions\n{\n    public static void RegisterServicesUsingAttribute(this IServiceCollection services)\n    {\n        // Define types that need matching\n        var scopedRegistration = typeof(ScopedRegistrationAttribute);\n        var scopedPriorityRegistration = typeof(ScopedPriorityRegistrationAttribute);\n        var singletonRegistration = typeof(SingletonRegistrationAttribute);\n        var transientRegistration = typeof(TransientRegistrationAttribute);\n        var transientPriorityRegistration = typeof(TransientPriorityRegistrationAttribute);\n        var types = AppDomain.CurrentDomain.GetAssemblies()\n            .SelectMany(s => s.GetTypes())\n            .Where(p => (p.IsDefined(scopedRegistration, true) || p.IsDefined(transientRegistration, true) ||\n                         p.IsDefined(singletonRegistration, true) || p.IsDefined(scopedPriorityRegistration, true) ||\n                         p.IsDefined(transientPriorityRegistration, true)) && !p.IsInterface)\n            .Select(s => new { Service = s.GetInterface($"I{s.Name}"), Implementation = s })\n            .Where(x => x.Service != null);\n        var typesList = types.ToList();\n        var scopedPriorityTypes = typesList\n            .Where(type => type.Implementation.IsDefined(scopedPriorityRegistration, false))\n            .ToList();\n        foreach (var type in scopedPriorityTypes)\n        {\n            services.AddScoped(type.Service ?? throw new InvalidOperationException(), type.Implementation);\n        }\n\n        var transientPriorityTypes = typesList\n            .Where(type => type.Implementation.IsDefined(transientPriorityRegistration, false))\n            .ToList();\n        foreach (var type in transientPriorityTypes)\n        {\n            services.AddTransient(type.Service ?? throw new InvalidOperationException(), type.Implementation);\n        }\n\n        foreach (var type in typesList)\n        {\n            if (type.Implementation.IsDefined(scopedRegistration, false))\n            {\n                services.AddScoped(type.Service ?? throw new InvalidOperationException(), type.Implementation);\n            }\n\n            if (type.Implementation.IsDefined(transientRegistration, false))\n            {\n                services.AddTransient(type.Service ?? throw new InvalidOperationException(), type.Implementation);\n            }\n\n            if (type.Implementation.IsDefined(singletonRegistration, false))\n            {\n                services.AddSingleton(type.Service ?? throw new InvalidOperationException(), type.Implementation);\n            }\n        }\n    }\n}\n\n///////////////\n\npublic class BaseQueryDto\n{\n    public int? PageSize { get; set; }\n    public bool First { get; set; }\n\n    public string? Before { get; set; }\n\n    public string? After { get; set; }\n\n    public bool Last { get; set; }\n    public int? Page { get; set; }\n\n    public string? Search { get; set; }\n}\n\n [HttpGet]\n    [Route("first")]\n    public async Task<ActionResult<KeysetPaginationResult<IdNameDto>>> GetFunds([FromQuery] BaseQueryDto baseQueryDto)\n    {\n        var list = await _cqQueryService.GetFundsAsync(baseQueryDto);\n\n        return Ok(list);\n    }\n\n    public async Task<KeysetPaginationResult<IdNameDto>> GetFundsAsync(BaseQueryDto baseQueryDto)\n    {\n        return await _cqRepositoryManager.cqQuery.GetFundsAsync(baseQueryDto);\n    }\n\n  using LinqKit;\n\n\npublic class cqQueryRepository : RepositoryBase<cqContext, pgp>, IcqQueryRepository\n{\n    private readonly IPaginationService _paginationService;\n    private readonly cqContext _cqContext;\n    private static readonly int CurrentDateAsInt = int.Parse(DateTime.Now.ToString("yyyyMMdd"));\n\n    public cqQueryRepository(cqContext cqContext, IPaginationService paginationService) : base(cqContext)\n    {\n        _cqContext = cqContext;\n        _paginationService = paginationService;\n    }\n\n    public async Task<KeysetPaginationResult<IdNameDto>> GetigosAsync(BaseQueryDto baseQueryDto)\n    {\n        var query = from o in _cqContext.qgos\n                    join oi in _cqContext.qgoidps on o.qgoKey equals oi.qgoKey into g1\n                    from ooi in g1.AsQueryable()\n                        .Where(x => x.qgoidpTypeCode == qgoidpType.idp.ToString()).DefaultIfEmpty()\n                    select new { Id = ooi.qgoidpValue ?? o.qgoId, Name = o.qgoName };\n        if (!string.IsNullOrWhiteSpace(baseQueryDto.Search))\n        {\n            query = query.Where(e => (e.Id + e.Name).Trim().ToLower().Contains(baseQueryDto.Search.Trim().ToLower()));\n        }\n\n        return await _paginationService.KeysetPaginateAsync(query.AsNoTracking(), b => b.Ascending(x => x.Id),\n            async id => await query.AsNoTracking().FirstAsync(x => x.Id == id),\n            q => q.Select(x => new IdNameDto { Id = x.Id, Name = x.Name }));\n    }\n\n    public async Task<KeysetPaginationResult<IdNameDto>> GetFundsAsync(BaseQueryDto baseQueryDto)\n    {\n        var predicate = PredicateBuilder.New<pgpidp>();\n        predicate = predicate.And(p => p.ValidFromDateKey <= CurrentDateAsInt);\n        predicate = predicate.And(p => p.ValidToDateKey >= CurrentDateAsInt);\n        predicate = predicate.And(p => p.pgpidpType == pgpidpTypeEnum.idp_ID.ToString());\n        var query = from p in _cqContext.pgps.AsExpandable()\n                    join pf in _cqContext.pgpFunds.AsExpandable() on p.pgpKey equals pf.pgpKey into g1\n                    from ppf in g1\n                    join pi in _cqContext.pgpidps.AsExpandable() on ppf.pgpKey equals pi.pgpKey into\n                        g2\n                    from ppfpi in g2.AsQueryable().Where(predicate).DefaultIfEmpty()\n                    where p.InceptionDateKey <= CurrentDateAsInt && p.TerminationDateKey >= CurrentDateAsInt &&\n                          p.pgpName != string.Empty\n                    select new { Id = ppfpi.pgpidpValue ?? p.pgpID, Name = p.pgpName };\n        if (!string.IsNullOrWhiteSpace(baseQueryDto.Search))\n        {\n            query = query.Where(e => (e.Id + e.Name).Trim().ToLower().Contains(baseQueryDto.Search.Trim().ToLower()));\n        }\n\n        return await _paginationService.KeysetPaginateAsync(query.AsNoTracking(), b => b.Ascending(x => x.Id),\n            async id => await query.AsNoTracking().FirstAsync(x => x.Id == id),\n            q => q.Select(x => new IdNameDto { Id = x.Id, Name = x.Name }));\n    }\n\n    public async Task<KeysetPaginationResult<IdNameDto>> GetbjpAsync(BaseQueryDto baseQueryDto)\n    {\n        var predicate = PredicateBuilder.New<pgpidp>();\n        predicate = predicate.And(p => p.ValidFromDateKey <= CurrentDateAsInt);\n        predicate = predicate.And(p => p.ValidToDateKey >= CurrentDateAsInt);\n        predicate = predicate.And(p => p.pgpidpType == pgpidpTypeEnum.idp_ID.ToString());\n        var query = from p in _cqContext.pgps\n                    join b in _cqContext.bjp on p.pgpKey equals b.pgpKey into g1\n                    from pb in g1\n                    join pi in _cqContext.pgpidps on pb.pgpKey equals pi.pgpKey into g2\n                    from pbpi in g2.AsQueryable().Where(predicate).DefaultIfEmpty()\n                    where p.InceptionDateKey <= CurrentDateAsInt && p.TerminationDateKey >= CurrentDateAsInt &&\n                          p.pgpName != string.Empty\n                    select new { Id = pbpi.pgpidpValue ?? p.pgpID, Name = p.pgpName };\n        if (!string.IsNullOrWhiteSpace(baseQueryDto.Search))\n        {\n            query = query.Where(e => (e.Id + e.Name).Trim().ToLower().Contains(baseQueryDto.Search.Trim().ToLower()));\n        }\n\n        return await _paginationService.KeysetPaginateAsync(query.AsNoTracking(), b => b.Ascending(x => x.Id),\n            async id => await query.AsNoTracking().FirstAsync(x => x.Id == id),\n            q => q.Select(x => new IdNameDto { Id = x.Id, Name = x.Name }));\n    }\n}\n\n public class HttpLoggingMiddleware : IMiddleware\n    {\n        private readonly IuserService _userService;\n\n        public HttpLoggingMiddleware(IuserService userService)\n        {\n            _userService = userService;\n        }\n\n        public async Task InvokeAsync(HttpContext context, RequestDelegate next)\n        {\n            if (!await ShouldSkipLogging(context))\n            {\n                await _userService.CreateuserEvent(JsonConvert.SerializeObject(new\n                {\n                    user = context.User.Identity?.Name,\n\n                }));\n            }\n\n[]            await next(context);\n\n            if (!await ShouldSkipLogging(context))\n            {\n                await _userService.CreateuserEvent(JsonConvert.SerializeObject(new\n                {\n                    user = context.User.Identity?.Name,\n\n                }));\n            }\n        }\n\n private static Task<bool> ShouldSkipLogging(HttpContext context)\n        {\n            return Task.FromResult(context.GetEndpoint()?.Metadata.GetMetadata<IAllowAnonymous>() != null\n                                   || context.Request.Headers.ContainsKey("X-Bypass-Logging")\n                                   || context.Request.Headers.ContainsKey("x-bypass-logging")\n                                   || context.Request.Query.ContainsKey("skiplogging")\n                                   || context.Request.Query.ContainsKey("SkipLogging")\n                                   || context.Request.Path.StartsWithSegments("/swagger", StringComparison.OrdinalIgnoreCase)\n                                   || context.Request.Path.StartsWithSegments("/log", StringComparison.OrdinalIgnoreCase)\n                                   || context.Request.Path.StartsWithSegments("/signin-oidc", StringComparison.OrdinalIgnoreCase)\n                                   || context.Request.Path.StartsWithSegments("/api/backgroundjobs", StringComparison.OrdinalIgnoreCase)\n                                   || context.Request.Path.StartsWithSegments("/hangfire", StringComparison.OrdinalIgnoreCase)\n            );\n        }\n\n        /////////////////////////\n\n\n\npublic class AzureSqlTokenDbConnectionInterceptor : DbConnectionInterceptor\n{\n    private readonly IAzureSqlTokenProvider _tokenProvider;\n\n    public AzureSqlTokenDbConnectionInterceptor(IAzureSqlTokenProvider tokenProvider)\n    {\n        _tokenProvider = tokenProvider;\n    }\n\n    public override InterceptionResult ConnectionOpening(DbConnection connection, ConnectionEventData eventData,\n        InterceptionResult result)\n    {\n        var sqlConnection = (SqlConnection)connection;\n        if (!ConnectionNeedsAccessToken(sqlConnection)) return base.ConnectionOpening(connection, eventData, result);\n        var (token, _) = _tokenProvider.GetAccessToken();\n        sqlConnection.AccessToken = token;\n        return base.ConnectionOpening(connection, eventData, result);\n    }\n\n    public override async ValueTask<InterceptionResult> ConnectionOpeningAsync(DbConnection connection,\n        ConnectionEventData eventData, InterceptionResult result, CancellationToken cancellationToken = default)\n    {\n        var sqlConnection = (SqlConnection)connection;\n        if (!ConnectionNeedsAccessToken(sqlConnection))\n            return await base.ConnectionOpeningAsync(connection, eventData, result, cancellationToken);\n        var (token, _) = await _tokenProvider.GetAccessTokenAsync(cancellationToken);\n        sqlConnection.AccessToken = token;\n        return await base.ConnectionOpeningAsync(connection, eventData, result, cancellationToken);\n    }\n\n    private static bool ConnectionNeedsAccessToken(IDbConnection connection)\n    {\n        var connectionStringBuilder = new SqlConnectionStringBuilder(connection.ConnectionString);\n        return\n            connectionStringBuilder.DataSource.Contains("database.windows.net", StringComparison.OrdinalIgnoreCase) &&\n            !connectionStringBuilder.DataSource.Contains("SqlExpress", StringComparison.OrdinalIgnoreCase) &&\n            string.IsNullOrEmpty(connectionStringBuilder.UserID);\n    }\n}\n\n// Simple interface that represents a token acquisition abstraction\npublic interface IAzureSqlTokenProvider\n{\n    Task<(string AccessToken, DateTimeOffset ExpiresOn)> GetAccessTokenAsync(\n        CancellationToken cancellationToken = default);\n\n    (string AccessToken, DateTimeOffset ExpiresOn) GetAccessToken();\n}\n\n// Core implementation that performs token acquisition with Azure Identity\npublic class AzureSqlTokenProvider : IAzureSqlTokenProvider\n{\n    private static readonly string[] _azureSqlScopes = new[] { "https://database.windows.net//.default" };\n\n    public async Task<(string AccessToken, DateTimeOffset ExpiresOn)> GetAccessTokenAsync(\n        CancellationToken cancellationToken = default)\n    {\n        var tokenRequestContext = new TokenRequestContext(_azureSqlScopes);\n        var token = await new ChainedTokenCredential(new ManagedIdentityCredential(), new VisualStudioCredential(),\n            new VisualStudioCodeCredential()).GetTokenAsync(tokenRequestContext, cancellationToken);\n        return (token.Token, token.ExpiresOn);\n    }\n\n    public (string AccessToken, DateTimeOffset ExpiresOn) GetAccessToken()\n    {\n        var tokenRequestContext = new TokenRequestContext(_azureSqlScopes);\n        var token = new ChainedTokenCredential(new ManagedIdentityCredential(), new VisualStudioCredential(),\n            new VisualStudioCodeCredential()).GetToken(tokenRequestContext);\n        return (token.Token, token.ExpiresOn);\n    }\n}\n\n// Decorator that caches tokens in the in-memory cache\npublic class CacheAzureSqlTokenProvider : IAzureSqlTokenProvider\n{\n    private const string _cacheKey = nameof(CacheAzureSqlTokenProvider);\n    private readonly IAzureSqlTokenProvider _inner;\n    private readonly IMemoryCache _cache;\n\n    public CacheAzureSqlTokenProvider(IAzureSqlTokenProvider inner, IMemoryCache cache)\n    {\n        _inner = inner;\n        _cache = cache;\n    }\n\n    public async Task<(string AccessToken, DateTimeOffset ExpiresOn)> GetAccessTokenAsync(\n        CancellationToken cancellationToken = default)\n    {\n        return await _cache.GetOrCreateAsync(_cacheKey, async cacheEntry =>\n        {\n            var (token, expiresOn) = await _inner.GetAccessTokenAsync(cancellationToken);\n\n            // AAD access tokens have a default lifetime of 1 hour, so we take a small safety margin\n            cacheEntry.SetAbsoluteExpiration(expiresOn.AddMinutes(-10));\n            return (token, expiresOn);\n        });\n    }\n\n    public (string AccessToken, DateTimeOffset ExpiresOn) GetAccessToken()\n    {\n        return _cache.GetOrCreate(_cacheKey, cacheEntry =>\n        {\n            var (token, expiresOn) = _inner.GetAccessToken();\n\n            // AAD access tokens have a default lifetime of 1 hour, so we take a small safety margin\n            cacheEntry.SetAbsoluteExpiration(expiresOn.AddMinutes(-10));\n            return (token, expiresOn);\n        });\n    }\n\n    ///\n\n\n\n\n\n\npublic class FilterService : IFilterService\n{\n    private readonly HttpClient _client;\n    private readonly IAzureTokenService _azureTokenService;\n    private readonly IHttpContextAccessor _httpContextAccessor;\n    private readonly IConfiguration _configuration;\n    private readonly IContextService _contextService;\n    private readonly ITokenAcquisition _tokenAcquisition;\n\n    public FilterService(HttpClient client, IAzureTokenService azureTokenService, IConfiguration configuration,\n        IHttpContextAccessor httpContextAccessor, IContextService contextService, ITokenAcquisition tokenAcquisition)\n    {\n        _client = client;\n        _azureTokenService = azureTokenService;\n        _configuration = configuration;\n        _httpContextAccessor = httpContextAccessor;\n        _contextService = contextService;\n        _tokenAcquisition = tokenAcquisition;\n    }\n\n    private async Task BuildClient()\n    {\n        _client.BaseAddress = new Uri(_configuration["FilterServiceBaseUri"] ??\n                                      throw new InvalidOperationException(\n                                          "FilterServiceBaseUri not set in configuration"));\n        if (_contextService.IsCientApp() || _contextService.IsQualifiedForAppAuthentication())\n        {\n            var accessToken =\n                await _azureTokenService.GetCachedAccessTokenForAzureResourceDefaultScopeUsingClientSecretCredential(\n                    _configuration["TenantId"], _configuration["ClientId"], _configuration["ISecret"],\n                    _configuration["FilterServiceAppIdUri"]);\n            _client.DefaultRequestHeaders.Add("Authorization", accessToken);\n        }\n        else\n        {\n            var userToken =\n                await _tokenAcquisition.GetAccessTokenForUserAsync(new[]\n                {\n                    $"{_configuration["FilterServiceAppIdUri"]}/.default"\n                });\n            _client.DefaultRequestHeaders.Add("Authorization", $"Bearer {userToken}");\n        }\n    }\n\n    public async Task<string> FetchAllFilterEvents()\n    {\n        if (!_client.DefaultRequestHeaders.Contains("Authorization"))\n            await BuildClient();\n        var response = await _client.GetAsync("/api/v1/event");\n        var responseJson = await response.Content.ReadAsStringAsync();\n        return responseJson;\n    }\n\n    public async Task<string> FetchFilterEvent(string? FilterEvent)\n    {\n        if (!_client.DefaultRequestHeaders.Contains("Authorization"))\n            await BuildClient();\n        var response = await _client.GetAsync($"/api/v1/event?event={FilterEvent}");\n        var responseJson = await response.Content.ReadAsStringAsync();\n        return responseJson;\n    }\n\n    public async Task<string> CreateFilterEvent(string? payload)\n    {\n        if (!_client.DefaultRequestHeaders.Contains("Authorization"))\n            await BuildClient();\n        var httpContent = new StringContent(payload!, Encoding.UTF8, "application/json");\n        var response = await _client.PostAsync("/api/v1/event/create", httpContent);\n        var responseJson = await response.Content.ReadAsStringAsync();\n        return responseJson;\n    }\n\n    public async Task<string> CreateFilterEvent(FilterEventCreationDto payload)\n    {\n        if (!_client.DefaultRequestHeaders.Contains("Authorization"))\n            await BuildClient();\n        var content = JsonConvert.SerializeObject(new\n        {\n            user = payload.User,\n            application = payload.Application,\n            eventName = payload.EventName,\n            description = payload.Description,\n        });\n        var httpContent = new StringContent(content, Encoding.UTF8, "application/json");\n        var response = await _client.PostAsync("/api/v1/event/create", httpContent);\n        var responseJson = await response.Content.ReadAsStringAsync();\n        return responseJson;\n    }\n\n    public async Task<string> CreateFilterEventForEntityUpdate(string appName, ChangeTracker changeTracker)\n    {\n        try\n        {\n            var entitiesToTrack = changeTracker.Entries().Where(e =>\n                e.State != EntityState.Detached && e.State != EntityState.Unchanged && e.State != EntityState.Added);\n            foreach (var entity in entitiesToTrack)\n            {\n                var tableName = entity.Metadata.GetTableName();\n                var userName = _httpContextAccessor?.HttpContext?.User?.Identity?.Name;\n                var endPoint =\n                    $"{_httpContextAccessor?.HttpContext?.Request.Method} {_httpContextAccessor?.HttpContext?.Request.Path.Value}";\n                var keys = entity.State != EntityState.Added\n                    ? entity.Properties.FirstOrDefault(p => p.Metadata.IsPrimaryKey())?.CurrentValue?.ToString()\n                    : null;\n                switch (entity.State)\n                {\n                    case EntityState.Modified:\n                        {\n                            var FilterData = JsonConvert.SerializeObject(new\n                            {\n                                newValue = JsonConvert.SerializeObject(\n                                    entity.Properties.ToDictionary(prop => prop.Metadata.Name,\n                                        prop => prop.CurrentValue)),\n                                oldValue = JsonConvert.SerializeObject(\n                                    entity.Properties.ToDictionary(prop => prop.Metadata.Name,\n                                        prop => prop.OriginalValue))\n                            });\n                            var content = JsonConvert.SerializeObject(new\n                            {\n                                user = userName,\n                                application = appName,\n                                endPoint,\n                                eventName = EventType.DATA_MODIFIED.ToString(),\n                                tableName,\n                                description = FilterData,\n                                keys\n                            });\n                            await CreateFilterEvent(content);\n                            foreach (var prop in entity.Properties)\n                            {\n                                if (prop.OriginalValue?.ToString() == prop.CurrentValue?.ToString()) continue;\n                                if (prop.Metadata.Name.ToLower() == "modifiedat" ||\n                                    prop.Metadata.Name.ToLower() == "modified" ||\n                                    prop.Metadata.Name.ToLower() == "createdat" ||\n                                    prop.Metadata.Name.ToLower() == "created") continue;\n                                var fieldName = prop.Metadata.Name;\n                                FilterData = JsonConvert.SerializeObject(new\n                                {\n                                    fieldName,\n                                    oldValue = prop.OriginalValue,\n                                    newValue = prop.CurrentValue,\n                                });\n                                content = JsonConvert.SerializeObject(new\n                                {\n                                    user = userName,\n                                    application = appName,\n                                    endPoint,\n                                    eventName = EventType.DATA_MODIFIED.ToString(),\n                                    tableName,\n                                    description = FilterData,\n                                    keys\n                                });\n                                await CreateFilterEvent(content);\n                            }\n\n                            break;\n                        }\n                    case EntityState.Deleted:\n                        {\n                            var FilterData = JsonConvert.SerializeObject(new\n                            {\n                                oldValue = JsonConvert.SerializeObject(\n                                    entity.Properties.ToDictionary(prop => prop.Metadata.Name,\n                                        prop => prop.OriginalValue))\n                            });\n                            var content = JsonConvert.SerializeObject(new\n                            {\n                                user = userName,\n                                application = appName,\n                                endPoint,\n                                eventName = EventType.DATA_DELETED.ToString(),\n                                tableName,\n                                description = FilterData,\n                                keys\n                            });\n                            await CreateFilterEvent(content);\n                            break;\n                        }\n                    case EntityState.Added:\n                        {\n                            var FilterData = JsonConvert.SerializeObject(new\n                            {\n                                newValue = JsonConvert.SerializeObject(\n                                    entity.Properties.ToDictionary(prop => prop.Metadata.Name,\n                                        prop => prop.CurrentValue)),\n                            });\n                            var content = JsonConvert.SerializeObject(new\n                            {\n                                user = userName,\n                                application = appName,\n                                endPoint,\n                                eventName = EventType.DATA_ADDED.ToString(),\n                                tableName,\n                                description = FilterData,\n                                keys\n                            });\n                            await CreateFilterEvent(content);\n                            break;\n                        }\n                }\n            }\n\n            return "Filter Data Logged Successfully";\n        }\n        catch (Exception)\n        {\n            return "Filter Data Logging Failed";\n        }\n    }\n\n    public async Task<string> CreateFilterEventForEntityAdded(string appName, IEnumerable<EntityEntry> entities)\n    {\n        try\n        {\n            foreach (var entity in entities.ToList())\n            {\n                var tableName = entity.Metadata.GetTableName();\n                var userName = _httpContextAccessor?.HttpContext?.User?.Identity?.Name;\n                var endPoint =\n                    $"{_httpContextAccessor?.HttpContext?.Request.Method} {_httpContextAccessor?.HttpContext?.Request.Path.Value}";\n                var keys = entity.Properties.FirstOrDefault(p => p.Metadata.IsPrimaryKey())?.CurrentValue?.ToString();\n                var FilterData = JsonConvert.SerializeObject(new\n                {\n                    newValue = JsonConvert.SerializeObject(\n                        entity.Properties.ToDictionary(prop => prop.Metadata.Name, prop => prop.CurrentValue)),\n                });\n                var content = JsonConvert.SerializeObject(new\n                {\n                    user = userName,\n                    application = appName,\n                    endPoint,\n                    eventName = EventType.DATA_ADDED.ToString(),\n                    tableName,\n                    description = FilterData,\n                    keys\n                });\n                await CreateFilterEvent(content);\n            }\n\n            return "Filter Data Logged Successfully";\n        }\n        catch (Exception)\n        {\n            return "Filter Data Logging Failed";\n        }\n    }\n}\n}\n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT * FROM sys.database_principals\n")))}g.isMDXComponent=!0}}]);